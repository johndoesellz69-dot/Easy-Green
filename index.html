<!-- Add Firebase SDKs before your script -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
    authDomain: "easy-green-website.firebaseapp.com",
    databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com/",
    projectId: "easy-green-website",
    storageBucket: "easy-green-website.appspot.com",
    messagingSenderId: "988776675269",
    appId: "1:988776675269:web:f2245f84a726d01f3e3dac"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const PRODUCTS = [
    {id:'c1',name:'Edibles',price:20,flavors:['Sour Patch','Skittlez','Swedish Fish','Watermelon','Starburst','Trolli','Peach Rings']},
    {id:'c2',name:'2G Ghost Disposable Carts',price:40,flavors:['Alien Burger','Durban Gushers','Papaya','Ghost Train Haze','Purple Ice cream Cake','Black Mamba']}
  ];

  function uid6(){return Math.random().toString(36).slice(2,8).toUpperCase();}
  function money(n){return '$'+n.toFixed(2);}

  let account = localStorage.getItem('eg_account') || '';
  const acctEl = document.getElementById('acctCode');

  function showMainSite(){ 
    document.getElementById('loginModal').classList.add('hidden');
    document.getElementById('mainWrap').classList.remove('hidden');
    document.getElementById('warningModal').classList.remove('hidden');
    acctEl.textContent = account;
    initSiteScripts();
  }

  /* ---- Login / Create ---- */
  document.getElementById('loginBtn').onclick = async () => {
    const code = document.getElementById('loginCode').value.trim();
    if(!code){ alert('Enter code'); return; }
    if(code==='joeygold54'){ showAdmin(); return; }

    const snapshot = await db.ref('accounts/'+code.toUpperCase()).get();
    if(!snapshot.exists()){ alert('Invalid code'); return; }

    account = code.toUpperCase();
    localStorage.setItem('eg_account', account);
    showMainSite();
  };

  document.getElementById('createCodeBtn').onclick = async () => {
    account = uid6();
    await db.ref('accounts/'+account).set({ created: Date.now() });
    localStorage.setItem('eg_account', account);
    alert('New code: '+account);
    showMainSite();
  };

  document.getElementById('ackBtn').onclick = () => {
    if(!document.getElementById('ackCheck').checked){ alert('Confirm rules'); return; }
    localStorage.setItem('eg_ack','1');
    document.getElementById('warningModal').classList.add('hidden');
  };

  document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.remove('hidden');
  document.getElementById('closeHelp').onclick = () => document.getElementById('helpModal').classList.add('hidden');

  /* ---- Site scripts ---- */
  function initSiteScripts(){
    const grid = document.getElementById('productsGrid'); grid.innerHTML='';
    PRODUCTS.forEach(p => {
      const el = document.createElement('div'); el.className='product';
      el.innerHTML = `
        <h3>${p.name}</h3>
        <div class="small">Price: ${money(p.price)}</div>
        <label>Flavor<select class="flavorSelect">${p.flavors.map(f=>`<option>${f}</option>`).join('')}</select></label>
        <label>Qty<input type="number" min="1" value="1" class="qtyInput" style="width:70px"></label>
        <div style="margin-top:8px"><button class="btn addBtn">Add</button></div>
      `;
      grid.appendChild(el);

      el.querySelector('.addBtn').addEventListener('click', async ()=>{
        const flavor = el.querySelector('.flavorSelect').value;
        const qty = Number(el.querySelector('.qtyInput').value)||1;
        const cartRef = db.ref('carts/'+account);
        const snapshot = await cartRef.get();
        const cart = snapshot.exists() ? snapshot.val() : [];
        cart.push({productId:p.id,name:p.name,flavor,qty,price:p.price});
        await cartRef.set(cart);
        alert('Added to cart');
        renderCart(cart);
      });
    });

    /* Load cart */
    async function loadCart(){
      const snapshot = await db.ref('carts/'+account).get();
      const cart = snapshot.exists() ? snapshot.val() : [];
      renderCart(cart);
    }

    function renderCart(cart){
      const cartList = document.getElementById('cartList');
      const cartTotalEl = document.getElementById('cartTotal');
      cartList.innerHTML = '';
      if(cart.length===0){ cartList.innerHTML='<div class="small">Cart empty.</div>'; cartTotalEl.textContent=''; return; }
      cart.forEach((it,idx)=>{
        const div = document.createElement('div'); div.className='cart-item';
        div.innerHTML = `
          <div>
            <div style="font-weight:600">${it.name} ×${it.qty}</div>
            <div class="small">${it.flavor}</div>
          </div>
          <div style="text-align:right">
            <div>${money(it.price*it.qty)}</div>
            <div style="margin-top:6px"><button class="btn ghost" data-i="${idx}">Remove</button></div>
          </div>
        `;
        div.querySelector('button').addEventListener('click', async e=>{
          cart.splice(Number(e.target.dataset.i),1);
          await db.ref('carts/'+account).set(cart);
          renderCart(cart);
        });
        cartList.appendChild(div);
      });
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      cartTotalEl.textContent = 'Total: '+money(total);
    }

    /* Purchase */
    document.getElementById('purchaseBtn').onclick = async ()=>{
      const cartRef = db.ref('carts/'+account);
      const snapshot = await cartRef.get();
      const cart = snapshot.exists() ? snapshot.val() : [];
      if(cart.length===0){ alert('Cart empty'); return; }
      const loc = document.getElementById('locationSelect').value;
      const tid = 'T-'+uid6();
      const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
      const ticket = {id:tid,account,location:loc,items:cart,total,status:'open',messages:[{from:'System',text:`Ticket created. Total ${money(total)}. Hide payment at ${loc}.`} ]};
      await db.ref('tickets/'+tid).set(ticket);
      await cartRef.remove();
      alert('Ticket created: '+tid);
      loadTickets();
      renderCart([]);
    };

    document.getElementById('clearBtn').onclick = async ()=>{ 
      if(confirm('Clear cart?')){ await db.ref('carts/'+account).remove(); renderCart([]); }
    };

    loadCart();

    /* Load tickets */
    async function loadTickets(){
      const ticketsArea = document.getElementById('ticketsArea');
      ticketsArea.innerHTML = '';
      const snapshot = await db.ref('tickets').orderByChild('account').equalTo(account).get();
      if(!snapshot.exists()){ ticketsArea.innerHTML='<div class="small">No tickets yet.</div>'; return; }
      snapshot.forEach(child=>{
        const t = child.val();
        const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Ticket ${t.id}</strong> <span class="small">(${t.status})</span></div>
            <div class="small">${t.location}</div>
          </div>
          <div class="small" style="margin-top:6px">${t.items.map(it=>`${it.name} ×${it.qty} (${it.flavor})`).join(' • ')}</div>
          <div style="margin-top:8px" id="ticket-${t.id}">
            <div class="ticket" id="chat-${t.id}">${(t.messages||[]).map(m=>m.image?`<div><strong>${m.from}:</strong><br><img src="${m.image}" style="max-width:100px;border-radius:6px"></div>`:`<div><strong>${m.from}:</strong> ${m.text}</div>`).join('')}</div>
            <input type="text" placeholder="Send message" id="msg-${t.id}" style="width:50%;padding:4px">
            <input type="file" accept="image/*" id="file-${t.id}" style="margin-top:4px">
            <button class="btn" onclick="sendUserMsg('${t.id}')">Send</button>
            <button class="btn ghost" onclick="markPaid('${t.id}')">Mark Paid</button>
            <button class="btn ghost" onclick="cancelOrder('${t.id}')">Cancel</button>
          </div>
        `;
        ticketsArea.appendChild(el);
      });
    }

    window.sendUserMsg = async function(tid){
      const msgEl=document.getElementById('msg-'+tid);
      const fileEl=document.getElementById('file-'+tid);
      const ticketRef = db.ref('tickets/'+tid);
      const snapshot = await ticketRef.get();
      if(!snapshot.exists()) return;
      const t = snapshot.val();
      if(fileEl.files[0]){
        const reader = new FileReader();
        reader.onload = async (e)=>{
          t.messages.push({from:'User',image:e.target.result});
          await ticketRef.set(t);
          loadTickets();
        };
        reader.readAsDataURL(fileEl.files[0]);
      }
      const txt = msgEl.value.trim();
      if(txt){ t.messages.push({from:'User',text:txt}); msgEl.value=''; await ticketRef.set(t); loadTickets(); }
    };

    window.markPaid = async function(tid){
      const ticketRef = db.ref('tickets/'+tid);
      const snapshot = await ticketRef.get(); if(!snapshot.exists()) return;
      const t = snapshot.val(); t.status='paid'; await ticketRef.set(t);
      loadTickets();
    };

    window.cancelOrder = async function(tid){
      if(!confirm('Cancel this order?')) return;
      await db.ref('tickets/'+tid).remove();
      loadTickets();
    };

    loadTickets();
  }
});
</script>

