<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;height:260px;overflow:auto}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
.flavor-stock{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.flavor-stock span{font-size:.88rem}
.option-disabled{color:#aaa !important}
</style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code: <input type="text" id="loginCode"></label>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
  </div>
</div>

<!-- Main site -->
<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green — Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>

  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
  </div>

  <div class="grid" role="main">
    <section class="card" aria-labelledby="productsLabel">
      <h2 id="productsLabel">Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>

    <aside class="card" aria-labelledby="cartLabel">
      <h2 id="cartLabel">Cart & Tickets</h2>
      <div id="cartList" aria-live="polite"></div>
      <div class="cart-total small" id="cartTotal"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>

  <footer>
    Easy Green only accepts cash payments. Fake cash will result in a ban.
  </footer>
</div>

<!-- Admin Screen -->
<div id="adminScreen">
  <h2>Admin Console</h2>
  <div style="margin-bottom:12px">
    <button class="btn" id="refreshTickets">Refresh Tickets</button>
    <button class="btn ghost" id="closeAdmin">Close Admin</button>
  </div>
  <h3>All Tickets</h3>
  <div id="allTicketsArea"></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "<YOUR_API_KEY>",
  authDomain: "<YOUR_PROJECT_ID>.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com/",
  projectId: "<YOUR_PROJECT_ID>",
  storageBucket: "<YOUR_PROJECT_ID>.appspot.com",
  messagingSenderId: "<YOUR_SENDER_ID>",
  appId: "<YOUR_APP_ID>"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

const PRODUCTS=[
  {id:'c1',name:'Edibles',price:20,flavors:['Sour Patch','Skittlez','Swedish Fish']},
  {id:'c2',name:'2G Ghost Disposable Carts',price:40,flavors:['Alien Burger','Durban Gushers','Papaya']}
];

function uid6(){return Math.random().toString(36).slice(2,8).toUpperCase();}
function money(n){return '$'+n.toFixed(2);}

let account=localStorage.getItem('eg_account')||'';
const acctEl=document.getElementById('acctCode');
acctEl.textContent=account;

function showMainSite(){
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  initSiteScripts();
}

/* Login */
document.getElementById('loginBtn').onclick=()=>{
  const code=document.getElementById('loginCode').value.trim();
  if(!code){alert('Enter code');return;}
  account=code.toUpperCase();
  localStorage.setItem('eg_account',account);
  acctEl.textContent=account;
  showMainSite();
};

/* Log Out */
document.getElementById('logoutBtn').onclick = () => {
  localStorage.removeItem('eg_account');
  account = '';
  document.getElementById('mainWrap').classList.add('hidden');
  document.getElementById('loginModal').classList.remove('hidden');
};

/* Admin Screen */
document.getElementById('closeAdmin').onclick=()=>{document.getElementById('adminScreen').style.display='none';};
document.getElementById('refreshTickets').onclick=()=>{renderAdminTickets();};

function showAdmin(){
  document.getElementById('adminScreen').style.display='block';
  renderAdminTickets();
}

/* Site scripts */
function initSiteScripts(){
  const grid=document.getElementById('productsGrid');grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const el=document.createElement('div');el.className='product';
    el.innerHTML = `<h3>${p.name}</h3>
      <div class="small">Price: ${money(p.price)}</div>
      <label>Flavor
        <select aria-label="flavor-${p.id}" class="flavorSelect">
          ${p.flavors.map(f=>`<option>${f}</option>`).join('')}
        </select>
      </label>
      <label>Qty<input type="number" min="1" value="1" class="qtyInput" style="width:70px"></label>
      <input type="file" accept="image/*" class="fileInput" style="margin-top:4px">
      <div style="margin-top:8px"><button class="btn addBtn">Add</button></div>`;
    grid.appendChild(el);
    el.querySelector('.addBtn').addEventListener('click',()=>{
      const flavor=el.querySelector('.flavorSelect').value;
      const qty=Number(el.querySelector('.qtyInput').value)||1;
      const fileInput = el.querySelector('.fileInput');
      const tid='T-'+Math.random().toString(36).slice(2,8).toUpperCase();
      const ticket={id:tid,account,items:[{product:p.name,flavor,qty,price:p.price}],status:'open',messages:[]};
      db.ref('tickets/'+tid).set(ticket);
      if(fileInput.files.length>0){
        const reader=new FileReader();
        reader.onload=e=>{
          db.ref('messages/'+account+'/'+tid).push({sender:'user',image:e.target.result});
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
      db.ref('messages/'+account+'/'+tid).push({sender:'user',text:`Ticket created: ${p.name} x${qty} (${flavor})`});
      alert('Ticket created: '+tid);
    });
  });

  // Render user tickets
  renderTickets();
}

function renderTickets(){
  const ticketsArea=document.getElementById('ticketsArea');
  db.ref('tickets').orderByChild('account').equalTo(account).on('value', snap=>{
    const ticketsObj = snap.val() || {};
    ticketsArea.innerHTML='';
    Object.values(ticketsObj).forEach(t=>{
      const el=document.createElement('div');
      el.className='card';
      el.style.marginBottom='8px';
      el.innerHTML=`
        <div style="font-weight:600">Ticket ${t.id} | Status: ${t.status}</div>
        <div class="small">${t.items.map(i=>i.product+' ×'+i.qty+' ('+i.flavor+')').join(' • ')}</div>
        <div id="chat-${t.id}" class="ticket"></div>
        <input placeholder="Message admin" id="msg-${t.id}" style="flex:1;padding:4px">
        <input type="file" accept="image/*" id="file-${t.id}" style="margin-top:4px">
        <button class="btn" onclick="sendMsg('${t.id}')">Send</button>
      `;
      ticketsArea.appendChild(el);

      // Real-time listener for messages
      const messagesRef = db.ref('messages/'+account+'/'+t.id);
      messagesRef.off();
      messagesRef.on('child_added', snapMsg=>{
        const msg = snapMsg.val();
        const divMsg = document.createElement('div');
        divMsg.className='ticket-entry';
        divMsg.innerHTML = msg.image ? `<strong>${msg.sender}:</strong><br><img src="${msg.image}" style="max-width:100px;border-radius:6px">` : `<strong>${msg.sender}:</strong> ${msg.text}`;
        document.getElementById('chat-'+t.id).appendChild(divMsg);
      });
    });
  });
}

window.sendMsg = (ticketId)=>{
  const msgInput=document.getElementById('msg-'+ticketId);
  const fileInput=document.getElementById('file-'+ticketId);
  const text = msgInput.value.trim();
  if(text) db.ref('messages/'+account+'/'+ticketId).push({sender:'user',text});
  if(fileInput.files.length>0){
    const reader=new FileReader();
    reader.onload=e=>{
      db.ref('messages/'+account+'/'+ticketId).push({sender:'user',image:e.target.result});
    };
    reader.readAsDataURL(fileInput.files[0]);
  }
  msgInput.value=''; fileInput.value='';
};

/* Admin Tickets */
function renderAdminTickets(){
  const allTicketsArea = document.getElementById('allTicketsArea');
  db.ref('tickets').on('value', snap => {
    const ticketsObj = snap.val() || {};
    allTicketsArea.innerHTML = '';
    Object.values(ticketsObj).forEach(t => {
      const div = document.createElement('div');
      div.className = 'card';
      div.style.marginBottom = '8px';
      div.innerHTML = `
        <div style="font-weight:600">Ticket ${t.id} | Account: ${t.account} | Status: ${t.status}</div>
        <div class="small">${t.items.map(i => i.product+' ×'+i.qty+' ('+i.flavor+')').join(' • ')}</div>
        <div id="adminChat-${t.id}" class="ticket"></div>
        <input placeholder="Admin message" id="adminMsg-${t.id}" style="flex:1;padding:4px">
        <input type="file" accept="image/*" id="adminFile-${t.id}" style="margin-top:4px">
        <button class="btn" onclick="sendAdmin('${t.account}','${t.id}')">Send</button>
      `;
      allTicketsArea.appendChild(div);

      // Real-time messages
      const messagesRef = db.ref('messages/'+t.account+'/'+t.id);
      messagesRef.off();
      messagesRef.on('child_added', snapMsg=>{
        const msg = snapMsg.val();
        const divMsg = document.createElement('div');
        divMsg.className='ticket-entry';
        divMsg.innerHTML = msg.image ? `<strong>${msg.sender}:</strong><br><img src="${msg.image}" style="max-width:100px;border-radius:6px">` : `<strong>${msg.sender}:</strong> ${msg.text}`;
        document.getElementById('adminChat-'+t.id).appendChild(divMsg);
      });
    });
  });
}

/* Admin send message */
window.sendAdmin=(acct,ticketId)=>{
  const msgInput=document.getElementById('adminMsg-'+ticketId);
  const fileInput=document.getElementById('adminFile-'+ticketId);
  const text = msgInput.value.trim();
  if(text) db.ref('messages/'+acct+'/'+ticketId).push({sender:'admin',text});
  if(fileInput.files.length>0){
    const reader=new FileReader();
    reader.onload=e=>{
      db.ref('messages/'+acct+'/'+ticketId).push({sender:'admin',image:e.target.result});
    };
    reader.readAsDataURL(fileInput.files[0]);
  }
  msgInput.value=''; fileInput.value='';
};

if(!account){document.getElementById('loginModal').classList.remove('hidden');} else showMainSite();

});
</script>
</body>
</html>
