<script>
// --- USER SIDE ---
function renderTickets() {
  ticketsArea.innerHTML = '';
  tickets.forEach(t => {
    const div = document.createElement('div');
    div.className = 'ticket';
    div.id = 'ticket-' + t.id;
    div.innerHTML = `
      <div class="ticket-entry"><strong>Ticket ${t.id}</strong> @ ${t.location} | Total ${money(t.total)}</div>
      <div id="chat-${t.id}" style="margin-top:6px;height:120px;overflow:auto;border-top:1px dashed #ddd;padding-top:4px"></div>
      <div style="margin-top:4px;display:flex;gap:4px">
        <input type="text" placeholder="Message" class="msgInput" style="flex:1">
        <input type="file" class="imgInput" style="flex:1">
        <button class="btn sendBtn">Send</button>
      </div>
    `;
    ticketsArea.appendChild(div);

    // --- Real-time chat listener for this ticket ---
    const chatEl = document.getElementById('chat-' + t.id);
    db.ref('messages/' + t.id).on('value', snap => {
      const msgs = snap.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m =>
        m.image
          ? `<div><strong>${m.from}:</strong><br><img src="${m.image}" style="max-width:100px;border-radius:6px"></div>`
          : `<div><strong>${m.from}:</strong> ${m.text}</div>`
      ).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // --- Send button logic ---
    div.querySelector('.sendBtn').onclick = () => {
      const textInput = div.querySelector('.msgInput');
      const fileInput = div.querySelector('.imgInput');
      const text = textInput.value.trim();
      const file = fileInput.files[0];

      if (!text && !file) {
        alert('Write a message or choose an image first');
        return;
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          db.ref('messages/' + t.id).push({ from: 'User', image: e.target.result });
          fileInput.value = '';
        };
        reader.readAsDataURL(file);
      }

      if (text) {
        db.ref('messages/' + t.id).push({ from: 'User', text });
        textInput.value = '';
      }
    };
  });
}

// --- ADMIN SIDE ---
function renderAdminTickets() {
  const area = document.getElementById('allTicketsArea');
  area.innerHTML = '';

  db.ref('tickets').once('value').then(snap => {
    const tickets = snap.val() || {};
    Object.values(tickets).forEach(t => {
      const div = document.createElement('div');
      div.className = 'ticket';
      div.innerHTML = `
        <div class="ticket-entry"><strong>${t.id}</strong> @ ${t.location} | Total ${money(t.total)} | Status: ${t.status}</div>
        <div id="admin-chat-${t.id}" style="margin-top:4px;height:120px;overflow:auto;border-top:1px dashed #ddd;padding-top:4px"></div>
        <div style="margin-top:4px;display:flex;gap:4px">
          <input type="text" placeholder="Message" class="msgInput" style="flex:1">
          <input type="file" class="imgInput" style="flex:1">
          <button class="btn sendBtn">Send</button>
        </div>
      `;
      area.appendChild(div);

      // --- Real-time chat listener ---
      const chatEl = document.getElementById('admin-chat-' + t.id);
      db.ref('messages/' + t.id).on('value', snap => {
        const msgs = snap.val() || {};
        chatEl.innerHTML = Object.values(msgs).map(m =>
          m.image
            ? `<div><strong>${m.from}:</strong><br><img src="${m.image}" style="max-width:100px;border-radius:6px"></div>`
            : `<div><strong>${m.from}:</strong> ${m.text}</div>`
        ).join('');
        chatEl.scrollTop = chatEl.scrollHeight;
      });

      // --- Send button logic ---
      div.querySelector('.sendBtn').onclick = () => {
        const textInput = div.querySelector('.msgInput');
        const fileInput = div.querySelector('.imgInput');
        const text = textInput.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) {
          alert('Write a message or choose an image first');
          return;
        }

        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            db.ref('messages/' + t.id).push({ from: 'Admin', image: e.target.result });
            fileInput.value = '';
          };
          reader.readAsDataURL(file);
        }

        if (text) {
          db.ref('messages/' + t.id).push({ from: 'Admin', text });
          textInput.value = '';
        }
      };
    });
  });
}
</script>
