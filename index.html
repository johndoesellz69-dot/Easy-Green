<!doctype html>    
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
/* ... keep all your existing CSS as-is ... */
</style>
</head>
<body>

<!-- Keep all existing HTML modals, mainWrap, and adminScreen as-is -->

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "<YOUR_API_KEY>",
  authDomain: "<YOUR_PROJECT_ID>.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com/",
  projectId: "<YOUR_PROJECT_ID>",
  storageBucket: "<YOUR_PROJECT_ID>.appspot.com",
  messagingSenderId: "<YOUR_SENDER_ID>",
  appId: "<YOUR_APP_ID>"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

const PRODUCTS=[{id:'c1',name:'Edibles',price:20,flavors:['Sour Patch','Skittlez','Swedish Fish','Watermelon','Starburst','Trolli','Peach Rings']},{id:'c2',name:'2G Ghost Disposable Carts',price:40,flavors:['Alien Burger','Durban Gushers','Papaya','Ghost Train Haze','Purple Ice cream Cake','Black Mamba']}];

function uid6(){return Math.random().toString(36).slice(2,8).toUpperCase();}
function money(n){return '$'+n.toFixed(2);}

let account=localStorage.getItem('eg_account')||'';
const acctEl=document.getElementById('acctCode');
function getAllCodes(){return JSON.parse(localStorage.getItem('eg_codes')||'[]');}
function addCode(c){let arr=getAllCodes();if(!arr.includes(c)){arr.push(c);localStorage.setItem('eg_codes',JSON.stringify(arr));}}
function cartKey(acc){return 'eg_cart_'+acc;}

function showMainSite(){
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  document.getElementById('warningModal').classList.remove('hidden');
  acctEl.textContent=account;
  initSiteScripts();
}

/* Login / Create */
document.getElementById('loginBtn').onclick=()=>{
  const code=document.getElementById('loginCode').value.trim();
  if(!code){alert('Enter code');return;}
  if(code==='joeygold54'){showAdmin();return;}
  const upper=code.toUpperCase();
  if(!getAllCodes().includes(upper)){alert('Invalid code');return;}
  account=upper;localStorage.setItem('eg_account',account);showMainSite();
};
document.getElementById('createCodeBtn').onclick=()=>{
  account=uid6();addCode(account);localStorage.setItem('eg_account',account);
  alert('New code: '+account);showMainSite();
};
document.getElementById('ackBtn').onclick=()=>{
  if(!document.getElementById('ackCheck').checked){alert('Confirm rules');return;}
  localStorage.setItem('eg_ack','1');document.getElementById('warningModal').classList.add('hidden');
};

/* First Time Help */
document.getElementById('helpBtn').onclick=()=>{document.getElementById('helpModal').classList.remove('hidden');};
document.getElementById('closeHelp').onclick=()=>{document.getElementById('helpModal').classList.add('hidden');};

/* Admin Screen */
document.getElementById('closeAdmin').onclick=()=>{document.getElementById('adminScreen').style.display='none';};
document.getElementById('refreshTickets').onclick=()=>{renderAdminTickets(); renderAdminStock();};

function showAdmin(){
  document.getElementById('adminScreen').style.display='block';
  renderAdminStock();
  renderAdminTickets();
}

/* Site scripts */
function initSiteScripts(){
  const grid=document.getElementById('productsGrid');grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const el=document.createElement('div');el.className='product';
    const stockRef = db.ref('stock/'+p.id);
    stockRef.once('value').then(snap=>{
      const stock = snap.val() || {};
      el.innerHTML = `<h3>${p.name}</h3>
        <div class="small">Price: ${money(p.price)}</div>
        <label>Flavor
          <select aria-label="flavor-${p.id}" class="flavorSelect">
            ${p.flavors.map(f=>{
              const disabled=stock[f]===false?'disabled class="option-disabled"':'';
              return `<option ${disabled}>${f}</option>`;
            }).join('')}
          </select>
        </label>
        <label>Qty<input type="number" min="1" value="1" class="qtyInput" style="width:70px"></label>
        <div style="margin-top:8px"><button class="btn addBtn">Add</button></div>`;
      grid.appendChild(el);
      el.querySelector('.addBtn').addEventListener('click',()=>{
        const flavor=el.querySelector('.flavorSelect').value;
        const qty=Number(el.querySelector('.qtyInput').value)||1;
        if(stock[flavor]===false){alert('Flavor out of stock');return;}
        addToCart({productId:p.id,name:p.name,flavor,qty,price:p.price,image:null});
      });
    });
  });

  let cart=JSON.parse(localStorage.getItem(cartKey(account))||'[]');
  const cartList=document.getElementById('cartList');const cartTotalEl=document.getElementById('cartTotal');const ticketsArea=document.getElementById('ticketsArea');
  function saveCart(){localStorage.setItem(cartKey(account),JSON.stringify(cart));renderCart();}
  function addToCart(item){cart.push(item);saveCart();alert('Added to cart');}

  function renderCart(){
    cartList.innerHTML='';if(cart.length===0){cartList.innerHTML='<div class="small">Cart empty.</div>';cartTotalEl.textContent='';return;}
    cart.forEach((it,idx)=>{
      const div=document.createElement('div');div.className='cart-item';
      div.innerHTML=`<div><div style="font-weight:600">${it.name} ×${it.qty}</div><div class="small">${it.flavor}</div>${it.image?'<img src="'+it.image+'" style="width:60px;margin-top:4px;border-radius:6px">':''}</div>
        <div style="text-align:right"><div>${money(it.price*it.qty)}</div><div style="margin-top:6px"><button class="btn ghost" data-i="${idx}">Remove</button></div></div>`;
      cartList.appendChild(div);
      div.querySelector('button').addEventListener('click',(e)=>{cart.splice(Number(e.target.dataset.i),1);saveCart();});
    });
    const total=cart.reduce((s,i)=>s+i.price*i.qty,0);cartTotalEl.textContent=`Total: ${money(total)}`;
  }

  /* Create ticket and push to Firebase */
  document.getElementById('purchaseBtn').addEventListener('click',()=>{
    if(cart.length===0){alert('Cart empty');return;}
    const loc=document.getElementById('locationSelect').value;
    const tid='T-'+Math.random().toString(36).slice(2,8).toUpperCase();
    const items=JSON.parse(JSON.stringify(cart));const total=items.reduce((s,i)=>s+i.price*i.qty,0);
    const ticket={id:tid,account,location:loc,items,total,status:'open',messages:[{from:'System',text:`Ticket created. Total ${money(total)}. Hide payment at ${loc}.`} ]};
    db.ref('tickets/'+tid).set(ticket).then(()=>{
      alert('Ticket created: '+tid);
      cart=[];saveCart();
    });
  });

  document.getElementById('clearBtn').addEventListener('click',()=>{if(confirm('Clear cart?')){cart=[];saveCart();}});
  renderCart();
  renderUserTickets();
}

/* Show user's tickets (read from Firebase in real-time) */
function renderUserTickets(){
  const ticketsArea=document.getElementById('ticketsArea');
  db.ref('tickets').orderByChild('account').equalTo(account).on('value',snap=>{
    const ticketsObj = snap.val()||{};
    ticketsArea.innerHTML='';
    const tickets = Object.values(ticketsObj);
    if(tickets.length===0){ticketsArea.innerHTML='<div class="small">No tickets yet.</div>';return;}
    tickets.forEach(t=>{
      const el=document.createElement('div');el.className='card';el.style.marginBottom='8px';
      el.innerHTML=`<div style="font-weight:600">Ticket ${t.id} | Location: ${t.location} | Status: ${t.status}</div>
        <div class="small">${t.items.map(i=>i.name+' ×'+i.qty+' ('+i.flavor+')').join(' • ')}</div>
        <div id="chat-${t.id}" class="ticket">${(t.messages||[]).map(m=>m.image?'<div><strong>'+m.from+':</strong><br><img src="'+m.image+'" style="max-width:100px;border-radius:6px"></div>':'<div><strong>'+m.from+':</strong> '+m.text+'</div>').join('')}</div>
        <input placeholder="Message admin" id="msg-'+t.id+'" style="flex:1;padding:4px"><input type="file" accept="image/*" id="file-'+t.id+'" style="margin-top:4px">
        <button class="btn" onclick="sendMsg('${t.id}')">Send</button>
        <button class="btn ghost" onclick="markPaid('${t.id}')">Mark as paid</button>`;
      ticketsArea.appendChild(el);
    });
  });
}

/* Admin Tickets real-time */
function renderAdminTickets(){
  const allTicketsArea = document.getElementById('allTicketsArea');
  db.ref('tickets').on('value', snap => {
    allTicketsArea.innerHTML = '';
    const ticketsObj = snap.val() || {};
    const tickets = Object.values(ticketsObj);
    if(tickets.length === 0){allTicketsArea.innerHTML = '<div class="small">No tickets yet.</div>';return;}
    tickets.forEach(t => {
      const div = document.createElement('div');
      div.className = 'card';
      div.style.marginBottom = '8px';
      div.innerHTML = `
        <div style="font-weight:600">Ticket ${t.id} | Account: ${t.account} | Location: ${t.location} | Status: ${t.status}</div>
        <div class="small">${t.items.map(i=>i.name+' ×'+i.qty+' ('+i.flavor+')').join(' • ')}</div>
        <div id="adminChat-${t.id}" class="ticket">${(t.messages||[]).map(m => m.image ? `<div><strong>${m.from}:</strong><br><img src="${m.image}" style="max-width:100px;border-radius:6px"></div>` : `<div><strong>${m.from}:</strong> ${m.text}</div>`).join('')}</div>
        <input placeholder="Admin message" id="adminMsg-${t.id}" style="flex:1;padding:4px">
        <input type="file" accept="image/*" id="adminFile-${t.id}" style="margin-top:4px">
        <button class="btn" onclick="sendAdmin('${t.account}','${t.id}')">Send</button>
        <button class="btn ghost" onclick="deleteOrder('${t.account}','${t.id}')">Delete</button>`;
      allTicketsArea.appendChild(div);
    });
  });
}

/* Admin Stock */
function renderAdminStock(){
  const stockArea = document.getElementById('adminStockArea');
  stockArea.innerHTML='';
  PRODUCTS.forEach(p=>{
    const div=document.createElement('div');div.style.marginBottom='8px';
    db.ref('stock/'+p.id).once('value').then(snap=>{
      const stock=snap.val()||{};
      div.innerHTML=`<div style="font-weight:600">${p.name}</div>${p.flavors.map(f=>{
        const st = stock[f]===false?'Out':'In';
        return `<div class="flavor-stock"><span>${f}</span><span>${st}</span></div>`;
      }).join('')}`;
      stockArea.appendChild(div);
    });
  });
}

/* Admin Actions */
window.sendAdmin=(acct,ticketId)=>{
  const msgInput=document.getElementById('adminMsg-'+ticketId);
  const fileInput=document.getElementById('adminFile-'+ticketId);
  const messages=[];
  if(msgInput.value.trim()!=='') messages.push({from:'Admin',text:msgInput.value.trim()});
  if(fileInput.files.length>0){
    const reader=new FileReader();
    reader.onload=(e)=>{messages.push({from:'Admin',image:e.target.result});appendAdminMsg(ticketId,messages);};
    reader.readAsDataURL(fileInput.files[0]);
  } else appendAdminMsg(ticketId,messages);
  msgInput.value='';fileInput.value='';
};
function appendAdminMsg(ticketId,msgs){
  db.ref('tickets/'+ticketId+'/messages').once('value').then(snap=>{
    const old = snap.val()||[];
    db.ref('tickets/'+ticketId+'/messages').set([...old,...msgs]);
  });
}
window.deleteOrder=(acct,ticketId)=>{if(confirm('Delete this ticket?')){db.ref('tickets/'+ticketId).remove();}};
window.sendMsg=(ticketId)=>{alert('Messaging feature placeholder. Implement chat send code here.')};
window.markPaid=(ticketId)=>{alert('Mark paid feature placeholder. Implement photo upload & status update here.')};

if(!account){document.getElementById('loginModal').classList.remove('hidden');} else showMainSite();
});
</script>
</body>
</html>





