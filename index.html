<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
/* small visual for disabled options (browser support varies) */
select option[disabled] { color: #999; }
</style>
</head>
<body>
<!-- (unchanged modals above) -->

<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green — Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap">
    <div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
    <button class="btn" id="helpBtn" style="margin-left:auto">First time help</button>
    <button class="btn ghost" id="aboutUserBtn">About Easy Green</button>
  </div>
  <!-- REFERRAL ADDITION: referral code + tickets -->
  <div style="margin-top:12px;padding:8px;background:#f0fff0;border:1px solid #cdeccd;border-radius:8px">
    <div id="referralDisplay" style="font-weight:bold">Your referral code is: ...</div>
    <div id="ticketCountDisplay" style="margin-top:4px">You have 0 tickets</div>
  </div>
  <!-- END REFERRAL ADDITION -->
  <div class="grid" role="main">
    <section class="card">
      <h2>Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>
    <aside class="card">
      <h2>Cart & Pickup</h2>
      <div>
        <label class="small">Pickup Location</label>
        <select id="locationSelect">
          <option value="Hasbrook Park">Hasbrook Park</option>
          <option value="Virginia Terrace Park">Virginia Terrace Park</option>
          <option value="Frontier Park">Frontier Park</option>
          <option value="Pioneer Park">Pioneer Park</option>
          <option value="Grealish Park">Grealish Park</option>
          <option value="Happiness Park">Happiness Park</option>
          <option value="Greenbrier Park">Greenbrier Park</option>
          <option value="Kimball Hill Park">Kimball Hill Park</option>
          <option value="Centennial Park">Centennial Park</option>
        </select>
      </div>
      <div style="margin-top:12px">
        <div id="cartList"></div>
        <div class="cart-total small" id="cartTotal"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
  <footer> Easy Green only accepts cash payments. </footer>
</div>

<!-- adminScreen unchanged -->

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = { /* unchanged config */ };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
let currentUser = null;
let currentUserIsAdmin = false;
let cart = [];
let stockCache = {};

// listen for stock changes
db.ref('stock').on('value', snap => {
  stockCache = snap.val() || {};
  try { renderProducts(); } catch(e){}
});

// Utility to generate referral code
function generateReferralCode() {
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const letter = letters[Math.floor(Math.random()*letters.length)];
  const digits = Math.floor(10000 + Math.random()*90000); // 5 digits
  return letter + digits;
}

// Account creation
document.getElementById('createCodeBtn').onclick = () => {
  const code = 'user-' + Math.random().toString(36).substr(2,6);
  const refCode = generateReferralCode();
  db.ref('users/' + code).set({
    created: Date.now(),
    referralCode: refCode,
    ticketsCount: 0
  });
  alert('Your code: ' + code);
  document.getElementById('loginCode').value = code;
};

// Login
document.getElementById('loginBtn').onclick = () => {
  const code = document.getElementById('loginCode').value.trim();
  if(!code) return alert('Enter a code');

  db.ref('users/' + code).once('value', snapshot => {
    let user = snapshot.val();
    if(!user) return alert('Invalid code');
    currentUser = code;
    currentUserIsAdmin = (code === 'user-9e21mr');
    document.getElementById('acctCode').innerText = code;
    document.getElementById('loginModal').classList.add('hidden');

    // REFERRAL ADDITION: ensure user has referralCode and show it
    if(!user.referralCode){
      const newRef = generateReferralCode();
      db.ref('users/' + code + '/referralCode').set(newRef);
      user.referralCode = newRef;
    }
    document.getElementById('referralDisplay').innerText =
      "Your referral code is: " + user.referralCode;

    // live listener for tickets count
    db.ref('users/' + code + '/ticketsCount').on('value', snap => {
      const count = snap.val() || 0;
      document.getElementById('ticketCountDisplay').innerText =
        "You have " + count + " tickets";
    });
    // END REFERRAL ADDITION

    if(currentUserIsAdmin) {
      document.getElementById('adminScreen').style.display = 'block';
    }

    document.getElementById('warningModal').classList.toggle('hidden', currentUserIsAdmin);
    renderTickets();
  });
};

// (rest of your script unchanged…)
</script>
</body>
</html>

