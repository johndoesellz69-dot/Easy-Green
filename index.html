<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
</style>
</head>
<body>
<!-- Login Modal -->
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
    </div>
    <div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
  </div>
</div>

<!-- Warning Modal -->
<div id="warningModal" class="modal-back hidden">
  <div class="modal">
    <h3>Warnings & Rules</h3>
    <ul>
      <li>Easy Green is not liable for any stolen Product/Payments.</li>
      <li>Use products safely.</li>
      <li>Respect site anonymity.</li>
    </ul>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ackCheck"> I agree
      </label>
      <button class="btn" id="ackBtn">Confirm</button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal-back hidden">
  <div class="modal">
    <h3>First Time Help</h3>
    <p>Welcome to Easy Green! Here's how it works:</p>
    <ol>
      <li>Select products and flavors you want.</li>
      <li>Add items to your cart and choose pickup location.</li>
      <li>Click Purchase to generate a ticket for your order.</li>
      <li>Use the chat under your ticket to send messages or images to admin.</li>
      <li>Admin can respond and send images back.</li>
      <li>Place the specified cash amount in an Envelope and hide it.</li>
      <li>Mark as paid and send a photo of your envelope.</li>
      <li>Admin will message you with pickup details after pickup.</li>
    </ol>
    <button class="btn" id="closeHelp">Got it!</button>
  </div>
</div>

<!-- Main -->
<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green â€” Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
    <button class="btn" id="helpBtn" style="margin-left:auto">First time help</button>
  </div>
  <div class="grid" role="main">
    <section class="card">
      <h2>Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>
    <aside class="card">
      <h2>Cart & Pickup</h2>
      <div>
        <label class="small">Pickup Location</label>
        <select id="locationSelect">
          <option value="Hasbrook Park">Hasbrook Park</option>
          <option value="Virginia Terrace Park">Virginia Terrace Park</option>
          <option value="Frontier Park">Frontier Park</option>
          <option value="Pioneer Park">Pioneer Park</option>
          <option value="Grealish Park">Grealish Park</option>
          <option value="Happiness Park">Happiness Park</option>
          <option value="Greenbrier Park">Greenbrier Park</option>
          <option value="Kimball Hill Park">Kimball Hill Park</option>
          <option value="Centennial Park">Centennial Park</option>
        </select>
      </div>
      <div style="margin-top:12px">
        <div id="cartList"></div>
        <div class="cart-total small" id="cartTotal"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
  <footer> Easy Green only accepts cash payments. </footer>
</div>

<!-- Admin Screen -->
<div id="adminScreen">
  <h2>Admin Console</h2>
  <div style="margin-bottom:12px">
    <button class="btn" id="refreshTickets">Refresh Tickets</button>
    <button class="btn ghost" id="closeAdmin">Close Admin</button>
  </div>
  <h3>All Tickets</h3>
  <div id="allTicketsArea"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "<YOUR_API_KEY>",
  authDomain: "easy-green-website.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com/",
  projectId: "easy-green-website",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
let currentUser = null;
let cart = [];

// Create account
document.getElementById('createCodeBtn').onclick = () => {
  const code = 'user-' + Math.random().toString(36).substr(2,6);
  db.ref('users/' + code).set({created:Date.now()});
  alert('Your code: ' + code);
  document.getElementById('loginCode').value = code;
};

// Login
document.getElementById('loginBtn').onclick = () => {
  const code = document.getElementById('loginCode').value.trim();
  if(!code) return alert('Enter a code');
  currentUser = code;
  document.getElementById('acctCode').innerText = code;
  document.getElementById('loginModal').classList.add('hidden');

  if(currentUser === 'joeygold54'){
    document.getElementById('adminScreen').style.display = 'block';
    renderTickets();
  } else {
    document.getElementById('warningModal').classList.remove('hidden');
  }
};

// Warning modal
document.getElementById('ackBtn').onclick = () => {
  if(!document.getElementById('ackCheck').checked) return alert('Check agree');
  document.getElementById('warningModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  renderTickets();
  renderProducts();
};

document.getElementById('closeHelp').onclick = () => document.getElementById('helpModal').classList.add('hidden');
document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.remove('hidden');
document.getElementById('logoutBtn').onclick = () => location.reload();
document.getElementById('clearBtn').onclick = () => { cart=[]; renderCart(); };

// Render products
function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  const sample = [
    {id:'bud1',name:'Edibles (Buy 3 get 1 free)',price:20,flavors:['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']},
    {id:'cart1',name:'2g Ghost Cart (Buy 1 get 1 $10 off)',price:40,flavors:['Alien Burger','Durban Gushers','Papaya','Ghost Train Haze','Purple Ice Cream Cake','Black Mamba']}
  ];
  sample.forEach(p=>{
    const div=document.createElement('div');
    div.className='product';
    let options = p.flavors.map(f=>`<option value="${f}">${f}</option>`).join('');
    div.innerHTML = `<h3>${p.name}</h3><div>$${p.price}</div>
      <select><option value="">Select Flavor</option>${options}</select>
      <button class="btn">Add</button>`;
    div.querySelector('button').onclick = ()=>{
      const flavor = div.querySelector('select').value || "None";
      cart.push({...p, selectedFlavor: flavor});
      renderCart();
    };
    grid.appendChild(div);
  });
}

// Render cart with deals
function renderCart(){
  const list=document.getElementById('cartList');
  list.innerHTML='';
  let total=0;

  // copy cart and calculate discountedPrice for each item
  let ediblesCount = cart.filter(c=>c.name.includes('Edibles')).length;
  let cartCount = cart.filter(c=>c.name.includes('Ghost Cart')).length;

  let ediblesFree = Math.floor(ediblesCount/4);
  let cartDiscounts = Math.floor(cartCount/2);

  cart.forEach(c=>{
    let discountedPrice = c.price;

    if(c.name.includes('Edibles')){
      discountedPrice = (ediblesCount* c.price - ediblesFree * c.price)/ediblesCount;
    } else if(c.name.includes('Ghost Cart')){
      discountedPrice = (cartCount * c.price - cartDiscounts*10)/cartCount;
    }

    c.discountedPrice = discountedPrice;
    total += discountedPrice;

    const row=document.createElement('div');
    row.className='cart-item';
    row.innerHTML=`<span>${c.name} (${c.selectedFlavor})</span><span>$${discountedPrice}</span>`;
    list.appendChild(row);
  });
  document.getElementById('cartTotal').innerText='Total $'+total.toFixed(2);
}

// Purchase -> create ticket
document.getElementById('purchaseBtn').onclick = () => {
  if(!cart.length) return alert('Empty cart');
  const id = 'tkt-'+Date.now();
  const total = cart.reduce((a,b)=>a+b.discountedPrice,0);
  const ticket = {id,total,location: document.getElementById('locationSelect').value,status:'pending',items: cart,user: currentUser};
  db.ref('tickets/'+id).set(ticket);
  db.ref('messages/'+id).push({from:currentUser,text:'Ticket created'});
  cart=[]; renderCart();
};

/* === TICKETS & CHAT WITH BASE64 IMAGE SUPPORT === */
function renderTickets(){
  const area = document.getElementById(currentUser==='joeygold54'?'allTicketsArea':'ticketsArea');
  area.innerHTML='';

  db.ref('tickets').off();
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val(); if(!t.id) t.id = snap.key;
    if(currentUser!=='joeygold54' && t.user !== currentUser) return;

    const itemsText = t.items.map(i=>`${i.name} (${i.selectedFlavor}) $${i.discountedPrice}`).join(', ');

    const div = document.createElement('div');
    div.className='ticket';
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:100px;overflow:auto;border-top:1px dashed #ddd;margin-top:4px;padding-top:4px"></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        ${currentUser==='joeygold54'?'<button class="btn ghost deleteBtn" style="margin-left:4px;">Delete</button>':''}
        ${currentUser!== 'joeygold54' ? '<button class="btn ghost cancelBtn" style="margin-left:4px;">Cancel Ticket</button>' : ''}
      </div>
    `;
    area.appendChild(div);

    const chatEl = document.getElementById('chat-'+t.id);
    db.ref('messages/'+t.id).off();
    db.ref('messages/'+t.id).on('value', ms => {
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m=>
        `<div><strong>${m.from==='joeygold54'?'admin':m.from}:</strong> ${m.text || ''}${m.image?'<br><img src="'+m.image+'" style="max-width:100px">':''}</div>`
      ).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // send message or image as base64
    div.querySelector('.sendBtn').onclick = ()=>{
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      const txt = inp.value.trim();

      if(fileInp.files.length>0){
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload = function(e){
          const base64 = e.target.result;
          db.ref('messages/'+t.id).push({from: currentUser, image: base64});
        };
        reader.readAsDataURL(file);
        fileInp.value='';
      }

      if(txt) db.ref('messages/'+t.id).push({from: currentUser, text: txt});
      inp.value='';
    };

    if(currentUser==='joeygold54'){
      div.querySelector('.deleteBtn').onclick = () => {
        if(confirm('Delete this ticket permanently?')){
          db.ref('tickets/'+t.id).remove();
          db.ref('messages/'+t.id).remove();
          div.remove();
        }
      };
    }

    // Cancel ticket button for users
    const cancelBtn = div.querySelector('.cancelBtn');
    if(cancelBtn){
      cancelBtn.onclick = () => {
        if(confirm('Are you sure you want to cancel this ticket?')){
          db.ref('tickets/'+t.id).remove();
          db.ref('messages/'+t.id).remove();
          div.remove();
        }
      };
    }
  });
}

document.getElementById('refreshTickets').onclick = renderTickets;
document.getElementById('closeAdmin').onclick = ()=>document.getElementById('adminScreen').style.display='none';
</script>
</body>
</html>

