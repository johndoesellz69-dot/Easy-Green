<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
  body{font-family:sans-serif;background:#f6fff6;margin:0;padding:0}
  header{background:#2f9c4a;color:#fff;padding:10px;font-size:20px;text-align:center}
  #login,#main,#admin{display:none;padding:10px}
  .ticket{border:1px solid #ccc;padding:6px;border-radius:6px;margin-bottom:8px;background:#fff}
</style>
</head>
<body>
<header>Easy Green</header>

<div id="login">
  <h3>Login</h3>
  <input id="loginEmail" type="email" placeholder="Email"><br>
  <input id="loginPass" type="password" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
  <h3>Create Account</h3>
  <input id="regEmail" type="email" placeholder="Email"><br>
  <input id="regPass" type="password" placeholder="Password"><br>
  <button id="createBtn">Create Account</button>
</div>

<div id="main">
  <h3>Your Tickets</h3>
  <div id="ticketArea"></div>
</div>

<div id="admin">
  <h3>All Tickets (Admin)</h3>
  <div id="allTicketsArea"></div>
</div>

<script>
  // --- Firebase setup ---
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    databaseURL: "YOUR_DB_URL",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_APPID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // --- DOM Elements ---
  const loginDiv = document.getElementById('login');
  const mainDiv = document.getElementById('main');
  const adminDiv = document.getElementById('admin');

  // --- Auth ---
  document.getElementById('loginBtn').onclick = () => {
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPass').value;
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => {
        if (pass === "joeygold54") {
          showAdmin();
        } else {
          showUser();
        }
      })
      .catch(e => alert(e.message));
  };

  document.getElementById('createBtn').onclick = () => {
    const email = document.getElementById('regEmail').value;
    const pass = document.getElementById('regPass').value;
    auth.createUserWithEmailAndPassword(email, pass)
      .then(() => alert("Account created, now log in."))
      .catch(e => alert(e.message));
  };

  function showUser(){
    loginDiv.style.display = "none";
    mainDiv.style.display = "block";
    adminDiv.style.display = "none";
    renderUserTickets();
  }

  function showAdmin(){
    loginDiv.style.display = "none";
    mainDiv.style.display = "none";
    adminDiv.style.display = "block";
    renderAdminTickets();
  }

  // --- User Tickets ---
  function renderUserTickets(){
    const uid = auth.currentUser.uid;
    const area = document.getElementById('ticketArea');
    db.ref('tickets').orderByChild('uid').equalTo(uid).on('value', snap => {
      area.innerHTML = "";
      const tickets = snap.val() || {};
      Object.keys(tickets).forEach(id => {
        const t = tickets[id];
        const div = document.createElement('div');
        div.className = 'ticket';
        div.innerHTML = `
          <div><strong>${id}</strong> | Status: ${t.status||'open'}</div>
          <div id="chat-${id}" style="height:120px;overflow:auto;border-top:1px solid #ccc;margin:4px 0;padding:4px"></div>
          <input type="text" class="msgInput" placeholder="Message">
          <button class="sendBtn">Send</button>
        `;
        area.appendChild(div);

        const chatEl = div.querySelector('#chat-' + id);

        // Messages listener
        db.ref('messages/'+id).on('value', msnap=>{
          const msgs = msnap.val()||{};
          chatEl.innerHTML = "";
          Object.values(msgs).forEach(m=>{
            chatEl.innerHTML += `<div><strong>${m.from}:</strong> ${m.text||''}</div>`;
          });
          chatEl.scrollTop = chatEl.scrollHeight;
        });

        // Sending
        div.querySelector('.sendBtn').onclick = ()=>{
          const text = div.querySelector('.msgInput').value.trim();
          if(!text) return;
          const msg = {from: auth.currentUser.email, text};
          db.ref('messages/'+id).push(msg);
          div.querySelector('.msgInput').value="";
        };
      });
    });
  }

  // --- Admin Tickets ---
  function renderAdminTickets(){
    const area = document.getElementById('allTicketsArea');
    db.ref('tickets').on('value', snap => {
      area.innerHTML = "";
      const tickets = snap.val() || {};
      Object.keys(tickets).forEach(id => {
        const t = tickets[id];
        const div = document.createElement('div');
        div.className = 'ticket';
        div.innerHTML = `
          <div><strong>${id}</strong> | Status: ${t.status||'open'}</div>
          <div id="admin-chat-${id}" style="height:120px;overflow:auto;border-top:1px solid #ccc;margin:4px 0;padding:4px"></div>
          <input type="text" class="msgInput" placeholder="Message">
          <button class="sendBtn">Send</button>
        `;
        area.appendChild(div);

        const chatEl = div.querySelector('#admin-chat-' + id);

        // Messages listener
        db.ref('messages/'+id).on('value', msnap=>{
          const msgs = msnap.val()||{};
          chatEl.innerHTML = "";
          Object.values(msgs).forEach(m=>{
            chatEl.innerHTML += `<div><strong>${m.from}:</strong> ${m.text||''}</div>`;
          });
          chatEl.scrollTop = chatEl.scrollHeight;
        });

        // Sending
        div.querySelector('.sendBtn').onclick = ()=>{
          const text = div.querySelector('.msgInput').value.trim();
          if(!text) return;
          const msg = {from:"Admin", text};
          db.ref('messages/'+id).push(msg);
          div.querySelector('.msgInput').value="";
        };
      });
    });
  }

  // Show login on load
  loginDiv.style.display = "block";
</script>
</body>
</html>


