<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Easy Green</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f6fff6; margin: 0; padding: 0; }
    header { background: #2f9c4a; color: white; padding: 15px; text-align: center; font-size: 24px; }
    .container { display: flex; }
    .products, .chat { flex: 1; padding: 20px; }
    .products { border-right: 1px solid #ddd; }
    .cart { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: white; }
    .chat-box { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; background: white; margin-bottom: 10px; }
    .message { margin: 5px 0; }
    .message strong { color: #2f9c4a; }
    .admin .message strong { color: #d9534f; }
    button { background: #2f9c4a; color: white; border: none; padding: 10px 15px; cursor: pointer; margin-top: 5px; }
    button:hover { background: #256f35; }
    input, select { padding: 5px; margin: 5px 0; width: 100%; }
    .ticket { border: 1px solid #ddd; margin-bottom: 10px; padding: 10px; background: #fff; }
    .ticket button { background: #d9534f; margin-top: 5px; }
    img.chat-image { max-width: 200px; border-radius: 8px; margin-top: 5px; }
  </style>
</head>
<body>
  <header>Easy Green</header>
  <div id="login-screen">
    <div style="padding:20px;max-width:400px;margin:auto;">
      <h2>Login / Create Account</h2>
      <input type="text" id="username" placeholder="Enter username">
      <input type="password" id="password" placeholder="Enter password">
      <button onclick="login()">Login</button>
      <button onclick="createAccount()">Create Account</button>
    </div>
  </div>
  <div id="main-screen" style="display:none;">
    <div class="container">
      <div class="products">
        <h3>Products</h3>
        <select id="product-select">
          <option value="Cart - Gelato">Cart - Gelato</option>
          <option value="Cart - Lemon Haze">Cart - Lemon Haze</option>
          <option value="Cart - Blue Dream">Cart - Blue Dream</option>
          <option value="Edible - Brownie">Edible - Brownie</option>
          <option value="Edible - Gummy Bears">Edible - Gummy Bears</option>
          <option value="Bud - OG Kush">Bud - OG Kush</option>
          <option value="Bud - Sour Diesel">Bud - Sour Diesel</option>
        </select>
        <input type="number" id="quantity" placeholder="Quantity" min="1">
        <button onclick="addToCart()">Add to Cart</button>
        <div class="cart">
          <h4>Your Cart</h4>
          <ul id="cart-list"></ul>
          <button onclick="checkout()">Purchase</button>
        </div>
      </div>
      <div class="chat">
        <h3>Chat</h3>
        <div id="chat-box" class="chat-box"></div>
        <input type="text" id="message-input" placeholder="Type a message...">
        <input type="file" id="image-input" accept="image/*">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>
  <div id="admin-screen" style="display:none;">
    <div style="padding:20px;">
      <h2>Admin - Support Tickets</h2>
      <div id="tickets"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    // ✅ Fixed Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
      authDomain: "easy-green-website.firebaseapp.com",
      databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com",
      projectId: "easy-green-website",
      storageBucket: "easy-green-website.appspot.com", // ✅ Correct bucket
      messagingSenderId: "988776675269",
      appId: "1:988776675269:web:f2245f84a726d01f3e3dac",
      measurementId: "G-PR35QWS2T6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentUser = null;
    let isAdmin = false;
    let currentCart = [];

    function login() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      if (password === "joeygold54") {
        isAdmin = true;
        currentUser = "admin";
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("admin-screen").style.display = "block";
        loadAdminTickets();
      } else if (username.trim() !== "" && password.trim() !== "") {
        currentUser = username;
        isAdmin = false;
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-screen").style.display = "block";
        loadMessages();
      }
    }

    function createAccount() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      if (username && password) {
        alert("Account created! Now log in.");
      }
    }

    function addToCart() {
      const product = document.getElementById("product-select").value;
      const quantity = document.getElementById("quantity").value;
      if (product && quantity > 0) {
        currentCart.push({ product, quantity });
        updateCartDisplay();
      }
    }

    function updateCartDisplay() {
      const cartList = document.getElementById("cart-list");
      cartList.innerHTML = "";
      currentCart.forEach(item => {
        const li = document.createElement("li");
        li.textContent = `${item.quantity} x ${item.product}`;
        cartList.appendChild(li);
      });
    }

    function checkout() {
      if (currentCart.length === 0) return;
      const ticketRef = push(ref(db, "tickets"));
      const ticketId = ticketRef.key;
      const newTicket = {
        user: currentUser,
        items: currentCart,
        messages: []
      };
      push(ref(db, "tickets/" + ticketId), newTicket);
      currentCart = [];
      updateCartDisplay();
      alert("Order placed. Support ticket created.");
    }

    function sendMessage() {
      const messageInput = document.getElementById("message-input");
      const imageInput = document.getElementById("image-input");
      const text = messageInput.value.trim();
      const file = imageInput.files[0];

      if (!text && !file) return;

      const ticketRef = ref(db, "tickets");
      onChildAdded(ticketRef, (snapshot) => {
        const ticketKey = snapshot.key;
        if (snapshot.val().user === currentUser || isAdmin) {
          if (file) {
            const imgRef = storageRef(storage, "chat_images/" + Date.now() + "-" + file.name);
            uploadBytes(imgRef, file).then(() => {
              getDownloadURL(imgRef).then(url => {
                push(ref(db, "tickets/" + ticketKey + "/messages"), {
                  sender: isAdmin ? "admin" : currentUser,
                  image: url,
                  timestamp: Date.now()
                });
              });
            });
            imageInput.value = "";
          }
          if (text) {
            push(ref(db, "tickets/" + ticketKey + "/messages"), {
              sender: isAdmin ? "admin" : currentUser,
              text: text,
              timestamp: Date.now()
            });
            messageInput.value = "";
          }
        }
      });
    }

    function loadMessages() {
      const chatBox = document.getElementById("chat-box");
      const ticketRef = ref(db, "tickets");
      onChildAdded(ticketRef, (snapshot) => {
        const ticket = snapshot.val();
        if (ticket.user === currentUser) {
          const messagesRef = ref(db, "tickets/" + snapshot.key + "/messages");
          onChildAdded(messagesRef, (msgSnap) => {
            const msg = msgSnap.val();
            const div = document.createElement("div");
            div.classList.add("message");
            div.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text || ""}`;
            if (msg.image) {
              div.innerHTML += `<br><img class="chat-image" src="${msg.image}">`;
            }
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
          });
        }
      });
    }

    function loadAdminTickets() {
      const ticketsDiv = document.getElementById("tickets");
      const ticketRef = ref(db, "tickets");
      onChildAdded(ticketRef, (snapshot) => {
        const ticket = snapshot.val();
        const div = document.createElement("div");
        div.classList.add("ticket");
        div.innerHTML = `<strong>User:</strong> ${ticket.user}<br><strong>Items:</strong> ${
          ticket.items ? ticket.items.map(i => `${i.quantity}x ${i.product}`).join(", ") : "None"
        }<br><div class="messages" id="messages-${snapshot.key}"></div>
        <button onclick="deleteTicket('${snapshot.key}')">Delete</button>`;
        ticketsDiv.appendChild(div);

        const messagesRef = ref(db, "tickets/" + snapshot.key + "/messages");
        onChildAdded(messagesRef, (msgSnap) => {
          const msg = msgSnap.val();
          const messagesDiv = div.querySelector(`#messages-${snapshot.key}`);
          const msgDiv = document.createElement("div");
          msgDiv.classList.add("message");
          msgDiv.innerHTML = `<strong>${msg.sender}:</strong> ${msg.text || ""}`;
          if (msg.image) {
            msgDiv.innerHTML += `<br><img class="chat-image" src="${msg.image}">`;
          }
          messagesDiv.appendChild(msgDiv);
        });
      });
    }

    window.login = login;
    window.createAccount = createAccount;
    window.addToCart = addToCart;
    window.checkout = checkout;
    window.sendMessage = sendMessage;
    window.deleteTicket = function(ticketId) {
      remove(ref(db, "tickets/" + ticketId));
      document.getElementById("tickets").innerHTML = "";
      loadAdminTickets();
    };
  </script>
</body>
</html>
