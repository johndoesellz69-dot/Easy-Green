<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
/* small visual for disabled options (browser support varies) */
select option[disabled] { color: #999; }
</style>
</head>
<body>
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
      <div class="loginNotice">(Login codes are case-sensitive. Ensure the 'user' part is lowercase. EX: user-123abc)</div>
    </div>
    <div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
    <div style="margin-top:8px;display:flex;justify-content:flex-end">
      <button class="btn ghost" id="aboutLoginBtn">About Easy Green</button>
    </div>
  </div>
</div>

<div id="warningModal" class="modal-back hidden">
  <div class="modal">
    <h3>Warnings & Rules</h3>
    <ul>
      <li>Easy Green is not liable for any stolen Product/Payments.</li>
      <li>Use products safely.</li>
      <li>Respect site anonymity.</li>
    </ul>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ackCheck"> I agree
      </label>
      <button class="btn" id="ackBtn">Confirm</button>
    </div>
  </div>
</div>

<div id="helpModal" class="modal-back hidden">
  <div class="modal">
    <h3>First Time Help</h3>
    <p>Welcome to Easy Green! Here's how it works:</p>
    <ol>
      <li>Select products and flavors you want.</li>
      <li>Add items to your cart and choose pickup location.</li>
      <li>Click Purchase to generate a ticket for your order.</li>
      <li>Use the chat under your ticket to send messages or images to admin.</li>
      <li>Admin can respond and send images back.</li>
      <li>Place the specified cash amount in an Envelope and hide it.</li>
      <li>Mark as paid and send a photo of your envelope and the cash inside.</li>
      <li>Admin will message you with item retrieval details after your payment is collected.</li>
      <li>TIPS: It is recommended to hide payments out of the publics view and way, and ensure nobody sees you hiding your payment.</li>
    </ol>
    <button class="btn" id="closeHelp">Got it!</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
  authDomain: "easy-green-website.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com",
  projectId: "easy-green-website",
  storageBucket: "easy-green-website.firebasestorage.app",
  messagingSenderId: "988776675269",
  appId: "1:988776675269:web:f2245f84a726d01f3e3dac",
  measurementId: "G-PR35QWS2T6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green â€” Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
    <div class="small" style="margin-left:12px">Your referral code: <span id="refCode">--</span></div>
    <div class="small" style="margin-left:12px">You have <span id="ticketCount">0</span> tickets</div>
    <button class="btn" id="helpBtn" style="margin-left:auto">First time help</button>
    <button class="btn ghost" id="aboutUserBtn">About Easy Green</button>
  </div>
  <div class="grid" role="main">
    <section class="card">
      <h2>Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>
    <aside class="card">
      <h2>Cart & Pickup</h2>
      <div>
        <label class="small">Pickup Location</label>
        <select id="locationSelect">
          <option value="Hasbrook Park">Hasbrook Park</option>
          <option value="Virginia Terrace Park">Virginia Terrace Park</option>
          <option value="Frontier Park">Frontier Park</option>
          <option value="Pioneer Park">Pioneer Park</option>
          <option value="Grealish Park">Grealish Park</option>
          <option value="Happiness Park">Happiness Park</option>
          <option value="Greenbrier Park">Greenbrier Park</option>
          <option value="Kimball Hill Park">Kimball Hill Park</option>
          <option value="Centennial Park">Centennial Park</option>
        </select>
      </div>
      <div style="margin-top:12px">
        <div id="cartList"></div>
        <div class="cart-total small" id="cartTotal"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
  <footer> Easy Green only accepts cash payments. </footer>
</div>

<div id="adminScreen">
  <h2>Admin Console</h2>
  <div style="margin-bottom:12px">
    <button class="btn" id="refreshTickets">Refresh Tickets</button>
    <button class="btn ghost" id="closeAdmin">Close Admin</button>
  </div>
  <h3>All Tickets</h3>
  <div id="allTicketsArea"></div>
</div>

<script>
let currentUser = null;
let currentUserIsAdmin = false;
let cart = [];
let userRefCode = null;
let stockCache = {}; // Part B support

/* --- Generate Referral Code --- */
function generateReferralCode() {
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const letter = letters[Math.floor(Math.random() * letters.length)];
  const number = Math.floor(10000 + Math.random() * 90000);
  return letter + number;
}

/* --- Update Referral UI --- */
function updateReferralUI() {
  document.getElementById('refCode').innerText = userRefCode || '--';
}

/* --- Update Ticket Count UI --- */
function updateTicketCountUI() {
  if(!currentUser) return;
  db.ref('raffleTickets').orderByChild('owner').equalTo(userRefCode).on('value', snap=>{
    const tickets = snap.val() || {};
    const count = Object.keys(tickets).length;
    document.getElementById('ticketCount').innerText = count;
  });
}

/* --- Create Account --- */
document.getElementById('createCodeBtn').onclick = () => {
  const code = 'user-' + Math.random().toString(36).substr(2,6);
  const refCode = generateReferralCode();
  db.ref('users/' + code).set({created:Date.now(), referralCode: refCode});
  alert('Your code: ' + code);
  document.getElementById('loginCode').value = code;
};

/* --- Login --- */
document.getElementById('loginBtn').onclick = () => {
  const code = document.getElementById('loginCode').value.trim();
  if(!code) return alert('Enter a code');

  db.ref('users/' + code).once('value', snapshot => {
    const user = snapshot.val();
    if(!user) return alert('Invalid code');
    currentUser = code;
    currentUserIsAdmin = (code === 'user-9e21mr');
    document.getElementById('acctCode').innerText = code;

    if(!user.referralCode){
      userRefCode = generateReferralCode();
      db.ref('users/' + code + '/referralCode').set(userRefCode);
    } else {
      userRefCode = user.referralCode;
    }
    updateReferralUI();

    document.getElementById('loginModal').classList.add('hidden');

    if(currentUserIsAdmin) {
      document.getElementById('adminScreen').style.display = 'block';
      initAdminUI(); // Part E
    }

    document.getElementById('warningModal').classList.toggle('hidden', currentUserIsAdmin);

    updateTicketCountUI();
    renderTickets();
  });
};

/* --- Warning Modal --- */
document.getElementById('ackBtn').onclick = () => {
  if(!document.getElementById('ackCheck').checked) return alert('Check agree');
  document.getElementById('warningModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  renderTickets();
  renderProducts();
};

/* --- Help & About --- */
document.getElementById('closeHelp').onclick = () => document.getElementById('helpModal').classList.add('hidden');
document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.remove('hidden');
document.getElementById('logoutBtn').onclick = () => location.reload();
document.getElementById('clearBtn').onclick = () => { cart=[]; renderCart(); };
document.getElementById('aboutLoginBtn').onclick = () => document.getElementById('aboutModal').classList.remove('hidden');
document.getElementById('aboutUserBtn').onclick = () => document.getElementById('aboutModal').classList.remove('hidden');
document.getElementById('closeAbout').onclick = () => document.getElementById('aboutModal').classList.add('hidden');
/* --- Render Products (Part B) --- */
function renderProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';
  db.ref('products').once('value', snap => {
    const products = snap.val() || {};
    for(const id in products){
      const p = products[id];
      stockCache[id] = p.stock || 0; // cache stock

      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <h3>${p.name}</h3>
        <div class="small">${p.description || ''}</div>
        <div class="row">
          <label>Qty</label>
          <input type="number" min="1" max="${p.stock||0}" value="1" id="qty_${id}" ${p.stock===0?'disabled':''}>
        </div>
        <div class="small">Price: $${p.price}</div>
        <button class="btn" id="add_${id}" ${p.stock===0?'disabled':''}>Add to Cart</button>
      `;
      grid.appendChild(div);

      document.getElementById('add_' + id).onclick = () => {
        const qty = parseInt(document.getElementById('qty_' + id).value);
        if(qty > stockCache[id]) return alert('Not enough stock');
        const item = {id, name:p.name, qty, price:p.price};
        cart.push(item);
        renderCart();
      };
    }
  });
}

/* --- Render Cart --- */
function renderCart() {
  const list = document.getElementById('cartList');
  list.innerHTML = '';
  let total = 0;
  cart.forEach((item,i)=>{
    total += item.qty*item.price;
    const div = document.createElement('div');
    div.className='cart-item';
    div.innerHTML = `${item.name} x ${item.qty} = $${item.qty*item.price} <button class="btn ghost" id="remove_${i}">Remove</button>`;
    list.appendChild(div);
    document.getElementById('remove_' + i).onclick = ()=>{
      cart.splice(i,1);
      renderCart();
    };
  });
  document.getElementById('cartTotal').innerText = 'Total: $' + total;
}

/* --- Create Raffle Ticket --- */
function createRaffleTicket(owner, items, location){
  return db.ref('raffleTickets').push({
    owner,
    items,
    location,
    status: 'pending',
    created: Date.now()
  });
}

/* --- Purchase Button (Part C) --- */
document.getElementById('purchaseBtn').onclick = () => {
  if(cart.length===0) return alert('Cart empty');
  const location = document.getElementById('locationSelect').value;
  createRaffleTicket(userRefCode, cart, location).then(()=>{
    alert('Purchase complete! Ticket generated.');
    cart=[];
    renderCart();
    updateTicketCountUI();
    renderTickets();
  });
};
/* --- Show Item Received / Referral (Part D) --- */
function showItemReceived(ticketId){
  const modalBack = document.createElement('div');
  modalBack.className='modal-back';
  modalBack.style.zIndex=2000;
  modalBack.innerHTML=`
    <div class="modal">
      <h3>Item Received</h3>
      <p>Did a friend refer you?</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="yesReferralBtn">Yes</button>
        <button class="btn ghost" id="noReferralBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#noReferralBtn').onclick=()=>{
    modalBack.remove();
    db.ref('tickets/'+ticketId).remove();
  };

  modalBack.querySelector('#yesReferralBtn').onclick=()=>{
    const entryDiv=document.createElement('div');
    entryDiv.style.marginTop='12px';
    entryDiv.innerHTML=`
      <label>Enter referral code: <input type="text" id="friendCode"></label>
      <div id="refWarning" style="color:red;font-size:0.85rem;margin-top:4px"></div>
      <button class="btn" id="submitReferral">Submit</button>
    `;
    modalBack.querySelector('.modal').appendChild(entryDiv);

    modalBack.querySelector('#submitReferral').onclick=()=>{
      const codeInput = modalBack.querySelector('#friendCode').value.trim();
      const warning = modalBack.querySelector('#refWarning');
      if(!codeInput) return warning.innerText='Enter a code';
      if(codeInput===userRefCode) return warning.innerText='You cannot use your own code';

      // Part D: Add raffle ticket to friend
      createRaffleTicket(codeInput, [], 'REFERRAL').then(()=>{
        modalBack.remove();
        db.ref('tickets/'+ticketId).remove();
      });
    };
  };
}

/* --- Render Tickets with Chat --- */
function renderTickets(){
  const area = document.getElementById(currentUserIsAdmin ? 'allTicketsArea' : 'ticketsArea');
  area.innerHTML='';
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.user) t.user='';
    if(!currentUserIsAdmin && t.user!==currentUser) return;

    const div = document.createElement('div');
    div.className='ticket';
    const itemsText = (t.items||[]).map(i=>`${i.name} x ${i.qty}`).join(', ');
    div.innerHTML=`
      <div><strong>${t.id}</strong> @ ${t.location} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:100px;overflow:auto;border-top:1px dashed #ddd;margin-top:4px;padding-top:4px"></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        ${currentUserIsAdmin?'<button class="btn ghost itemHiddenBtn">Item Hidden</button>':''}
      </div>
    `;
    area.appendChild(div);

    const chatEl = document.getElementById('chat-'+t.id);
    db.ref('messages/'+t.id).on('value', ms=>{
      const msgs = ms.val()||{};
      chatEl.innerHTML = Object.values(msgs).map(m=>{
        const displayName=(m.from==='user-9e21mr' && currentUser!=='user-9e21mr')?'admin':m.from;
        return `<div><strong>${displayName}:</strong> ${m.text||''}${m.image?'<br><img src="'+m.image+'" style="max-width:100px">':''}</div>`;
      }).join('');
      chatEl.scrollTop=chatEl.scrollHeight;
    });

    div.querySelector('.sendBtn').onclick=()=>{
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      const txt = inp.value.trim();

      if(fileInp.files.length>0){
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload=function(e){
          db.ref('messages/'+t.id).push({from:currentUser,image:e.target.result});
        };
        reader.readAsDataURL(file);
        fileInp.value='';
      }

      if(txt) db.ref('messages/'+t.id).push({from:currentUser,text:txt});
      inp.value='';
    };

    div.querySelector('.cancelTicketBtn').onclick=()=>{
      if(confirm('Are you sure you want to cancel this ticket?')){
        db.ref('tickets/'+t.id).remove();
        db.ref('messages/'+t.id).remove();
        div.remove();
      }
    };

    div.querySelector('.markPaidBtn').onclick=()=>{
      db.ref('messages/'+t.id).push({from:currentUser,text:'Payment hidden. Product will be securely hidden and ready for pickup.'});
    };

    if(currentUserIsAdmin){
      div.querySelector('.itemHiddenBtn').onclick=()=>{
        db.ref('messages/'+t.id).push({from:currentUser,text:'Item has been hidden. Refer to photos below for location.'});
        db.ref('tickets/'+t.id+'/status').set('readyForReceived'); // Admin hides item
      };
    }
  });
}
/* --- Admin UI & Buttons (Part E & F) --- */
function initAdminUI(){
  if(!currentUserIsAdmin) return;

  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;

  // Complete Order Button per ticket
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    const ticketDiv = document.querySelector(`.ticket div strong:contains("${t.id}")`)?.parentNode?.parentNode;
    if(!ticketDiv) return;

    if(!ticketDiv.querySelector('.completeOrderBtn')){
      const btn = document.createElement('button');
      btn.className = 'btn completeOrderBtn';
      btn.innerText = 'Complete Order';
      btn.style.marginTop = '6px';
      ticketDiv.appendChild(btn);

      btn.onclick = ()=>{
        db.ref('tickets/'+t.id+'/status').set('complete');
        db.ref('raffleTickets').push({owner:t.user, code:userRefCode}); // Give raffle ticket now
        btn.disabled = true;
        btn.style.background='#ccc';
      };
    }
  });

  // Raffle Winner Button
  const raffleBtn = document.createElement('button');
  raffleBtn.className='btn';
  raffleBtn.innerText='Raffle Winner';
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick=()=>{
    const modalBack = document.createElement('div');
    modalBack.className='modal-back';
    modalBack.style.zIndex=2000;
    modalBack.innerHTML=`
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = ()=>modalBack.remove();

    modalBack.querySelector('#submitWinnerBtn').onclick = ()=>{
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if(!winnerCode) return alert('Enter a user code');

      const ticketId = 'raffle-' + Date.now();
      const ticket = {id:ticketId,total:0,location:'RAFFLE',status:'winner',items:[],user:winnerCode};
      db.ref('tickets/'+ticketId).set(ticket);
      db.ref('messages/'+ticketId).push({from:currentUser,text:'RAFFLE WINNER! You have won the raffle.'});
      alert('Raffle winner ticket created for ' + winnerCode);
      modalBack.remove();
    };
  };
}

// Call Admin UI init when admin logs in
if(currentUserIsAdmin){
  document.getElementById('adminScreen').style.display='block';
  initAdminUI();
}
/* --- Part B: Updated renderProducts() with stock check --- */
let stockCache = {}; // cache for product stock from Firebase

function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML='';

  // Sample products (keep original product data)
  const sample = [
    {id:'bud1',name:'Edibles (Buy 3 get 1 free)',price:20,flavors:['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']},
    {id:'cart1',name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)',price:30,flavors:['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple']}
  ];

  // Listen for stock updates
  db.ref('stock').on('value', snap=>{
    stockCache = snap.val() || {};
  });

  sample.forEach(p=>{
    const div = document.createElement('div');
    div.className='product';

    const title = document.createElement('h3');
    title.textContent = p.name;

    // Check stock
    const isOut = stockCache[p.id]==='out';
    const priceDiv = document.createElement('div');
    priceDiv.textContent=`$${p.price}` + (isOut ? ' (Out of Stock)' : '');

    const select = document.createElement('select');
    const defOpt = document.createElement('option');
    defOpt.value=''; defOpt.textContent='Select Flavor'; select.appendChild(defOpt);
    p.flavors.forEach(f=>{
      const option=document.createElement('option'); option.value=f; option.textContent=f;
      select.appendChild(option);
    });

    const btn=document.createElement('button');
    btn.className='btn'; btn.textContent='Add';
    btn.disabled = isOut;
    btn.onclick=()=>{
      const flavor = select.value || 'None';
      if(!flavor) return alert('Select a flavor');
      cart.push({...p,selectedFlavor:flavor});
      renderCart();
    };

    div.appendChild(title);
    div.appendChild(priceDiv);
    div.appendChild(select);
    div.appendChild(btn);

    grid.appendChild(div);
  });
}

/* --- Part C: Updated purchaseBtn onclick with numbered raffle tickets --- */
let raffleCounter = 0; // numbered raffle tickets

document.getElementById('purchaseBtn').onclick=()=>{
  if(!cart.length) return alert('Empty cart');

  const ticketId='tkt-'+Date.now();
  let total=0,ediblesCount=0,muhaCount=0;
  cart.forEach(c=>{ total+=c.price; if(c.name.includes('Edibles')) ediblesCount++; if(c.name.includes('Muha Meds')) muhaCount++; });
  total-=Math.floor(ediblesCount/4)*20;
  total-=Math.floor(muhaCount/2)*5;

  const ticket = {id:ticketId,total:total,location:document.getElementById('locationSelect').value,status:'pending',items:cart,user:currentUser};

  // Save ticket
  db.ref('tickets/'+ticketId).set(ticket);
  db.ref('messages/'+ticketId).push({from:currentUser,text:'Ticket created'});

  // Increment raffle counter and create raffle ticket with number
  raffleCounter++;
  db.ref('raffleTickets/'+raffleCounter).set({owner:currentUser,code:userRefCode});

  cart=[]; renderCart();
};
/* --- Part D: Update showItemReceived referral submission --- */
function showItemReceived(ticketId){
  const modalBack = document.createElement('div');
  modalBack.className='modal-back';
  modalBack.style.zIndex=2000;
  modalBack.innerHTML=`
    <div class="modal">
      <h3>Item Received</h3>
      <p>Did a friend refer you?</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="yesReferralBtn">Yes</button>
        <button class="btn ghost" id="noReferralBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#noReferralBtn').onclick=()=>{
    modalBack.remove();
    db.ref('tickets/'+ticketId).remove();
  };

  modalBack.querySelector('#yesReferralBtn').onclick=()=>{
    const entryDiv=document.createElement('div');
    entryDiv.style.marginTop='12px';
    entryDiv.innerHTML=`
      <label>Enter referral code: <input type="text" id="friendCode"></label>
      <div id="refWarning" style="color:red;font-size:0.85rem;margin-top:4px"></div>
      <button class="btn" id="submitReferral">Submit</button>
    `;
    modalBack.querySelector('.modal').appendChild(entryDiv);

    modalBack.querySelector('#submitReferral').onclick=()=>{
      const codeInput = modalBack.querySelector('#friendCode').value.trim();
      const warning = modalBack.querySelector('#refWarning');
      if(!codeInput) return warning.innerText='Enter a code';
      if(codeInput===userRefCode) return warning.innerText='You cannot use your own code';

      // Only now give the referred friend a raffle ticket
      raffleCounter++;
      db.ref('raffleTickets/'+raffleCounter).set({owner: codeInput, referredBy: userRefCode});

      modalBack.remove();
      db.ref('tickets/'+ticketId).remove();
    };
  };
}
/* --- Part E: Admin Complete Order Button & initAdminUI --- */
function initAdminUI(){
  if(!currentUserIsAdmin) return;

  // Insert per-ticket Complete Order buttons in allTicketsArea
  const ticketsArea = document.getElementById('allTicketsArea');

  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.id) t.id = snap.key;

    let ticketDiv = document.getElementById('admin-ticket-'+t.id);
    if(!ticketDiv){
      ticketDiv = document.createElement('div');
      ticketDiv.id = 'admin-ticket-'+t.id;
      ticketDiv.className = 'ticket';
      const itemsText = (t.items||[]).map(i=>`${i.name} (${i.selectedFlavor})`).join(', ');
      ticketDiv.innerHTML=`
        <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
        <div><em>Items: ${itemsText}</em></div>
        <button class="btn completeOrderBtn" style="margin-top:6px;background:#ccc" disabled>Complete Order</button>
      `;
      ticketsArea.appendChild(ticketDiv);
    }

    // Wire Complete Order button
    const btn = ticketDiv.querySelector('.completeOrderBtn');
    db.ref('tickets/'+t.id+'/readyForReceived').on('value', snap=>{
      const val = snap.val();
      if(val){ btn.disabled=false; btn.style.background='green'; }
      else { btn.disabled=true; btn.style.background='#ccc'; }
    });

    btn.onclick=()=>{
      // Only allow giving raffle ticket if item is marked retrieved
      raffleCounter++;
      db.ref('raffleTickets/'+raffleCounter).set({owner: t.user, referredBy: t.user}); // Self-entry ticket
      db.ref('tickets/'+t.id).remove();
      ticketDiv.remove();
    };
  });
}

// Call initAdminUI after showing admin screen
// Replace this line in your login handler:
// document.getElementById('adminScreen').style.display = 'block';
// With this:
document.getElementById('adminScreen').style.display = 'block';
initAdminUI();
/* --- Part F: User-side Render Tickets with Item Received --- */
function renderTicketsWithReceived(){
  const area = document.getElementById('ticketsArea');
  area.innerHTML='';

  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.user || t.user !== currentUser) return;

    const div = document.createElement('div');
    div.className='ticket';
    div.id = 'user-ticket-' + t.id;

    const itemsText = (t.items||[]).map(i=>`${i.name} (${i.selectedFlavor})`).join(', ');

    div.innerHTML=`
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <button class="btn itemReceivedBtn" style="margin-top:6px;background:#ccc" disabled>Item Received</button>
    `;

    area.appendChild(div);

    const btn = div.querySelector('.itemReceivedBtn');

    // Enable button if admin marked ticket ready
    db.ref('tickets/'+t.id+'/readyForReceived').on('value', snap=>{
      const val = snap.val();
      if(val){ btn.disabled=false; btn.style.background='green'; }
      else { btn.disabled=true; btn.style.background='#ccc'; }
    });

    btn.onclick = () => showItemReceived(t.id);
  });
}

// Initial call after login
renderTicketsWithReceived();
  </script/>
  </base>
  </html>
  
