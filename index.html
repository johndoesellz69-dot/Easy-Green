<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
select option[disabled] { color: #999; }
</style>
</head>
<body>
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
      <div class="loginNotice">(Login codes are case-sensitive. Ensure the 'user' part is lowercase. EX: user-123abc)</div>
    </div>
    <div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
    <div style="margin-top:8px;display:flex;justify-content:flex-end">
      <button class="btn ghost" id="aboutLoginBtn">About Easy Green</button>
    </div>
  </div>
</div>

<div id="warningModal" class="modal-back hidden">
  <div class="modal">
    <h3>Warnings & Rules</h3>
    <ul>
      <li>Easy Green is not liable for any stolen Product/Payments.</li>
      <li>Use products safely.</li>
      <li>Respect site anonymity.</li>
    </ul>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ackCheck"> I agree
      </label>
      <button class="btn" id="ackBtn">Confirm</button>
    </div>
  </div>
</div>

<div id="helpModal" class="modal-back hidden">
  <div class="modal">
    <h3>First Time Help</h3>
    <p>Welcome to Easy Green! Here's how it works:</p>
    <ol>
      <li>Select products and flavors you want.</li>
      <li>Add items to your cart and choose pickup location.</li>
      <li>Click Purchase to generate a ticket for your order.</li>
      <li>Use the chat under your ticket to send messages or images to admin.</li>
      <li>Admin can respond and send images back.</li>
      <li>Place the specified cash amount in an Envelope and hide it.</li>
      <li>Mark as paid and send a photo of your envelope and the cash inside.</li>
      <li>Admin will message you with item retrieval details after your payment is collected.</li>
      <li>TIPS: It is recommended to hide payments out of the publics view and way, and ensure nobody sees you hiding your payment.</li>
    </ol>
    <button class="btn" id="closeHelp">Got it!</button>
  </div>
</div>

<div id="aboutModal" class="modal-back hidden">
  <div class="modal">
    <h3>About Easy Green</h3>
    <p>
      Welcome to Easy Green! We are proud to be the only local Cannabis service that is fully anonymous. 
      If you wish to obtain cannabis discreetly—without meeting a random sketchy dealer in person, or if you 
      do not have access to a nearby dispensary—Easy Green is here for you. Simply select a pickup location 
      nearest to you and enjoy our secure and simple exchange process.  
      We are based in Arlington Heights and proudly serve anyone in or near the area.  
      Take advantage of our exceptional deals and competitive pricing, as we believe everyone should have access to quality cannabis regardless of budget.  
      We are continually expanding our product selection and pickup locations, and will soon offer additional items beyond cannabis.  
      Enjoy Easy Green, and please consider sharing our website!
    </p>
    <button class="btn" id="closeAbout">Close</button>
  </div>
</div>

<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green — Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
    <div class="small" style="margin-left:12px">Your referral code: <span id="refCode">--</span></div>
    <div class="small" style="margin-left:12px">You have <span id="ticketCount">0</span> tickets</div>
    <button class="btn" id="helpBtn" style="margin-left:auto">First time help</button>
    <button class="btn ghost" id="aboutUserBtn">About Easy Green</button>
  </div>
  <div class="grid" role="main">
    <section class="card">
      <h2>Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>
    <aside class="card">
      <h2>Cart & Pickup</h2>
      <div>
        <label class="small">Pickup Location</label>
        <select id="locationSelect">
          <option value="Hasbrook Park">Hasbrook Park</option>
          <option value="Virginia Terrace Park">Virginia Terrace Park</option>
          <option value="Frontier Park">Frontier Park</option>
          <option value="Pioneer Park">Pioneer Park</option>
          <option value="Grealish Park">Grealish Park</option>
          <option value="Happiness Park">Happiness Park</option>
          <option value="Greenbrier Park">Greenbrier Park</option>
          <option value="Kimball Hill Park">Kimball Hill Park</option>
          <option value="Centennial Park">Centennial Park</option>
        </select>
      </div>
      <div style="margin-top:12px">
        <div id="cartList"></div>
        <div class="cart-total small" id="cartTotal"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
  <footer> Easy Green only accepts cash payments. </footer>
</div>

<div id="adminScreen">
  <h2>Admin Console</h2>
  <div style="margin-bottom:12px">
    <button class="btn" id="refreshTickets">Refresh Tickets</button>
    <button class="btn ghost" id="closeAdmin">Close Admin</button>
  </div>
  <h3>All Tickets</h3>
  <div id="allTicketsArea"></div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
  authDomain: "easy-green-website.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com",
  projectId: "easy-green-website",
  storageBucket: "easy-green-website.firebasestorage.app",
  messagingSenderId: "988776675269",
  appId: "1:988776675269:web:f2245f84a726d01f3e3dac",
  measurementId: "G-PR35QWS2T6"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === Global Variables === */
let currentUser = null;
let currentUserIsAdmin = false;
let cart = [];
let userRefCode = null;
let stockCache = {};

/* --- Referral Code Generator --- */
function generateReferralCode() {
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const letter = letters[Math.floor(Math.random() * letters.length)];
  const number = Math.floor(10000 + Math.random() * 90000);
  return letter + number;
}

/* --- Update referral display --- */
function updateReferralUI() {
  document.getElementById('refCode').innerText = userRefCode || '--';
}

/* --- Update ticket count display --- */
function updateTicketCountUI() {
  if (!currentUser) return;
  db.ref('raffleTickets').orderByChild('owner').equalTo(userRefCode).on('value', snap => {
    const tickets = snap.val() || {};
    const count = Object.keys(tickets).length;
    document.getElementById('ticketCount').innerText = count;
  });
}

/* --- Login / Create Account --- */
document.getElementById('createCodeBtn').onclick = () => {
  const code = 'user-' + Math.random().toString(36).substr(2, 6);
  const refCode = generateReferralCode();
  db.ref('users/' + code).set({ created: Date.now(), referralCode: refCode });
  alert('Your code: ' + code);
  document.getElementById('loginCode').value = code;
};

document.getElementById('loginBtn').onclick = () => {
  const code = document.getElementById('loginCode').value.trim();
  if (!code) return alert('Enter a code');

  db.ref('users/' + code).once('value', snapshot => {
    const user = snapshot.val();
    if (!user) return alert('Invalid code');

    currentUser = code;
    currentUserIsAdmin = (code === 'user-9e21mr');
    document.getElementById('acctCode').innerText = code;

    if (!user.referralCode) {
      userRefCode = generateReferralCode();
      db.ref('users/' + code + '/referralCode').set(userRefCode);
    } else {
      userRefCode = user.referralCode;
    }

    updateReferralUI();
    document.getElementById('loginModal').classList.add('hidden');

    if (currentUserIsAdmin) {
      document.getElementById('adminScreen').style.display = 'block';
    }

    document.getElementById('warningModal').classList.toggle('hidden', currentUserIsAdmin);

    updateTicketCountUI();
    renderTickets();
  });
};

/* --- Warning Modal --- */
document.getElementById('ackBtn').onclick = () => {
  if (!document.getElementById('ackCheck').checked) return alert('Check agree');
  document.getElementById('warningModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  renderTickets();
  renderProducts();
};

/* --- Help & About Buttons --- */
document.getElementById('closeHelp').onclick = () => document.getElementById('helpModal').classList.add('hidden');
document.getElementById('helpBtn').onclick = () => document.getElementById('helpModal').classList.remove('hidden');
document.getElementById('logoutBtn').onclick = () => location.reload();
document.getElementById('clearBtn').onclick = () => { cart = []; renderCart(); };
document.getElementById('aboutLoginBtn').onclick = () => document.getElementById('aboutModal').classList.remove('hidden');
document.getElementById('aboutUserBtn').onclick = () => document.getElementById('aboutModal').classList.remove('hidden');
document.getElementById('closeAbout').onclick = () => document.getElementById('aboutModal').classList.add('hidden');
/* --- Render Products with Stock Check --- */
function renderProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  const sample = [
    { id: 'bud1', name: 'Edibles (Buy 3 get 1 free)', price: 20, flavors: ['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings'] },
    { id: 'cart1', name: '2g Muha Meds Carts (Buy 1 get 1 $5 off)', price: 30, flavors: ['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple'] }
  ];

  sample.forEach(p => {
    const div = document.createElement('div');
    div.className = 'product';

    const title = document.createElement('h3');
    title.textContent = p.name;

    const priceDiv = document.createElement('div');
    priceDiv.textContent = `$${p.price}`;

    const select = document.createElement('select');
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = 'Select Flavor';
    select.appendChild(defOpt);

    p.flavors.forEach(f => {
      const option = document.createElement('option');
      option.value = f;
      option.textContent = f;
      select.appendChild(option);
    });

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Add';

    // Fetch stock status from Firebase cache
    db.ref('stock/' + p.id).once('value', snap => {
      const val = snap.val();
      stockCache[p.id] = val || 'in';
      if (stockCache[p.id] === 'out') btn.disabled = true;
    });

    btn.onclick = () => {
      const flavor = select.value || 'None';
      if (!flavor) return alert('Select a flavor');
      if (stockCache[p.id] === 'out') return alert('Out of stock');
      cart.push({ ...p, selectedFlavor: flavor });
      renderCart();
    };

    div.appendChild(title);
    div.appendChild(priceDiv);
    div.appendChild(select);
    div.appendChild(btn);
    grid.appendChild(div);
  });
}

/* --- Render Cart --- */
function renderCart() {
  const list = document.getElementById('cartList');
  list.innerHTML = '';
  let total = 0, ediblesCount = 0, muhaCount = 0;
  cart.forEach(c => {
    if (c.name.includes('Edibles')) ediblesCount++;
    if (c.name.includes('Muha Meds')) muhaCount++;
    total += c.price;
  });
  total -= Math.floor(ediblesCount / 4) * 20;
  total -= Math.floor(muhaCount / 2) * 5;

  cart.forEach(c => {
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `<span>${c.name} (${c.selectedFlavor})</span><span>$${c.price}</span>`;
    list.appendChild(row);
  });
  document.getElementById('cartTotal').innerText = 'Total $' + total;
}
/* --- Purchase Button & Raffle Ticket Creation --- */
let raffleCounter = 1; // Counter for numbering raffle tickets

function createRaffleTicket(userCode) {
  const ticketId = 'raffle-' + raffleCounter++;
  const ticket = {
    id: ticketId,
    total: 0,
    location: 'RAFFLE',
    status: 'winner',
    items: [],
    user: userCode
  };
  db.ref('tickets/' + ticketId).set(ticket);
  db.ref('messages/' + ticketId).push({ from: currentUser, text: 'RAFFLE WINNER! You have won the raffle.' });
  return ticketId;
}

document.getElementById('purchaseBtn').onclick = () => {
  if (!cart.length) return alert('Empty cart');

  let total = 0, ediblesCount = 0, muhaCount = 0;
  cart.forEach(c => {
    total += c.price;
    if (c.name.includes('Edibles')) ediblesCount++;
    if (c.name.includes('Muha Meds')) muhaCount++;
  });
  total -= Math.floor(ediblesCount / 4) * 20;
  total -= Math.floor(muhaCount / 2) * 5;

  const ticketId = 'tkt-' + Date.now();
  const ticket = {
    id: ticketId,
    total: total,
    location: document.getElementById('locationSelect').value,
    status: 'pending',
    items: cart,
    user: currentUser
  };

  db.ref('tickets/' + ticketId).set(ticket);
  db.ref('messages/' + ticketId).push({ from: currentUser, text: 'Ticket created' });

  // Do NOT add raffle ticket yet; only add when admin marks item as hidden + complete order
  cart = [];
  renderCart();
};

/* --- Admin: Item Hidden + Complete Order --- */
function initAdminUI() {
  document.querySelectorAll('.itemHiddenBtn').forEach(btn => {
    btn.onclick = () => {
      const ticketId = btn.closest('.ticket').querySelector('strong').innerText;
      db.ref('messages/' + ticketId).push({ from: currentUser, text: 'Item has been hidden. Refer to photos below for location of item.' });
      db.ref('tickets/' + ticketId + '/status').set('readyForReceived');
    };
  });

  const completeBtn = document.createElement('button');
  completeBtn.className = 'btn';
  completeBtn.innerText = 'Complete Order';
  document.getElementById('allTicketsArea').parentNode.insertBefore(completeBtn, document.getElementById('allTicketsArea'));

  completeBtn.onclick = () => {
    db.ref('tickets').once('value', snap => {
      const tickets = snap.val() || {};
      Object.keys(tickets).forEach(tid => {
        const t = tickets[tid];
        if (t.status === 'readyForReceived') {
          db.ref('tickets/' + tid + '/status').set('complete');
          // Give user their raffle ticket for this purchase
          createRaffleTicket(t.user);
        }
      });
    });
  };

  // Admin Raffle Winner Button
  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.innerText = 'Raffle Winner';
  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick = () => {
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();
    modalBack.querySelector('#submitWinnerBtn').onclick = () => {
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if (!winnerCode) return alert('Enter a user code');
      createRaffleTicket(winnerCode);
      alert('Raffle winner ticket created for ' + winnerCode);
      modalBack.remove();
    };
  };
}
/* --- Item Received & Referral Logic --- */
function showItemReceived(ticketId) {
  const modalBack = document.createElement('div');
  modalBack.className = 'modal-back';
  modalBack.style.zIndex = 2000;
  modalBack.innerHTML = `
    <div class="modal">
      <h3>Item Received</h3>
      <p>Did a friend refer you?</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="yesReferralBtn">Yes</button>
        <button class="btn ghost" id="noReferralBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#noReferralBtn').onclick = () => {
    modalBack.remove();
    db.ref('tickets/' + ticketId).remove();
  };

  modalBack.querySelector('#yesReferralBtn').onclick = () => {
    const entryDiv = document.createElement('div');
    entryDiv.style.marginTop = '12px';
    entryDiv.innerHTML = `
      <label>Enter referral code: <input type="text" id="friendCode"></label>
      <div id="refWarning" style="color:red;font-size:0.85rem;margin-top:4px"></div>
      <button class="btn" id="submitReferral">Submit</button>
    `;
    modalBack.querySelector('.modal').appendChild(entryDiv);

    modalBack.querySelector('#submitReferral').onclick = () => {
      const codeInput = modalBack.querySelector('#friendCode').value.trim();
      const warning = modalBack.querySelector('#refWarning');

      if (!codeInput) return warning.innerText = 'Enter a code';
      if (codeInput === userRefCode) return warning.innerText = 'You cannot use your own code';

      // Give friend their raffle ticket
      createRaffleTicket(codeInput);

      modalBack.remove();
      db.ref('tickets/' + ticketId).remove();
    };
  };
}
/* --- Render Tickets with Item Received Button & Admin Complete Order --- */
function renderTicketsWithReceived() {
  const area = document.getElementById('ticketsArea');
  area.innerHTML = '';

  db.ref('tickets').on('child_added', snap => {
    const t = snap.val();
    if (!t.user || t.user !== currentUser) return;

    const div = document.createElement('div');
    div.className = 'ticket';
    const itemsText = t.items.map(i => `${i.name} (${i.selectedFlavor})`).join(', ');
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <button class="btn itemReceivedBtn" style="margin-top:6px;background:#ccc" disabled>Item Received</button>
    `;
    area.appendChild(div);

    // Listen if readyForReceived turns true
    db.ref('tickets/' + t.id + '/readyForReceived').on('value', snap => {
      const val = snap.val();
      const btn = div.querySelector('.itemReceivedBtn');
      if (val) { btn.disabled = false; btn.style.background = 'green'; }
      else { btn.disabled = true; btn.style.background = '#ccc'; }
    });

    div.querySelector('.itemReceivedBtn').onclick = () => showItemReceived(t.id);
  });
}

/* --- Admin UI Init & Complete Order Button --- */
function initAdminUI() {
  // Add Complete Order Button
  const compBtn = document.createElement('button');
  compBtn.className = 'btn';
  compBtn.innerText = 'Complete Order';
  const allTicketsArea = document.getElementById('allTicketsArea');
  allTicketsArea.parentNode.insertBefore(compBtn, allTicketsArea);

  compBtn.onclick = () => {
    db.ref('tickets').once('value', snap => {
      const tickets = snap.val() || {};
      Object.keys(tickets).forEach(tid => {
        db.ref('tickets/' + tid + '/readyForReceived').set(true);
      });
    });
  };
}

// Call admin UI init when admin logs in
if (currentUserIsAdmin) {
  initAdminUI();
}
/* === Admin: Raffle Winner Button & Sequential Raffle Numbers === */
if (currentUserIsAdmin) {
  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.innerText = 'Raffle Winner';
  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  // Track raffle numbers sequentially
  let raffleCounter = 1;
  db.ref('raffleTickets').once('value', snap => {
    const allTickets = snap.val() || {};
    const maxNum = Object.values(allTickets)
      .map(t => t.number || 0)
      .reduce((a, b) => Math.max(a, b), 0);
    raffleCounter = maxNum + 1;
  });

  raffleBtn.onclick = () => {
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();

    modalBack.querySelector('#submitWinnerBtn').onclick = () => {
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if (!winnerCode) return alert('Enter a user code');

      // Sequential raffle number assignment
      const ticketId = 'raffle-' + Date.now();
      const ticket = {
        id: ticketId,
        total: 0,
        location: 'RAFFLE',
        status: 'winner',
        items: [],
        user: winnerCode,
        raffleNumber: raffleCounter
      };
      db.ref('tickets/' + ticketId).set(ticket);
      db.ref('messages/' + ticketId).push({ from: currentUser, text: 'RAFFLE WINNER! You have won the raffle.' });

      // Also add to raffleTickets node for proper numbering
      db.ref('raffleTickets').push({ owner: winnerCode, number: raffleCounter });

      alert('Raffle winner ticket created for ' + winnerCode + ' with raffle number ' + raffleCounter);
      raffleCounter++; // increment for next raffle
      modalBack.remove();
    };
  };
}
