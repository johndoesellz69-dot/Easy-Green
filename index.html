<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
select option[disabled] { color: #999; }
</style>
</head>
<body>
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
      <div class="loginNotice">(Login codes are case-sensitive. Ensure the 'user' part is lowercase. EX: user-123abc)</div>
    </div>
    <div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
    <div style="margin-top:8px;display:flex;justify-content:flex-end">
      <button class="btn ghost" id="aboutLoginBtn">About Easy Green</button>
    </div>
  </div>
</div>

<div id="warningModal" class="modal-back hidden">
  <div class="modal">
    <h3>Warnings & Rules</h3>
    <ul>
      <li>Easy Green is not liable for any stolen Product/Payments.</li>
      <li>Use products safely.</li>
      <li>Respect site anonymity.</li>
    </ul>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ackCheck"> I agree
      </label>
      <button class="btn" id="ackBtn">Confirm</button>
    </div>
  </div>
</div>

<div id="helpModal" class="modal-back hidden">
  <div class="modal">
    <h3>First Time Help</h3>
    <p>Welcome to Easy Green! Here's how it works:</p>
    <ol>
      <li>Select products and flavors you want.</li>
      <li>Add items to your cart and choose pickup location.</li>
      <li>Click Purchase to generate a ticket for your order.</li>
      <li>Use the chat under your ticket to send messages or images to admin.</li>
      <li>Admin can respond and send images back.</li>
      <li>Place the specified cash amount in an Envelope and hide it.</li>
      <li>Mark as paid and send a photo of your envelope and the cash inside.</li>
      <li>Admin will message you with item retrieval details after your payment is collected.</li>
      <li>TIPS: It is recommended to hide payments out of the publics view and way, and ensure nobody sees you hiding your payment.</li>
    </ol>
    <button class="btn" id="closeHelp">Got it!</button>
  </div>
</div>

<div id="aboutModal" class="modal-back hidden">
  <div class="modal">
    <h3>About Easy Green</h3>
    <p>
      Welcome to Easy Green! We are proud to be the only local Cannabis service that is fully anonymous. 
      If you wish to obtain cannabis discreetly—without meeting a random sketchy dealer in person, or if you 
      do not have access to a nearby dispensary—Easy Green is here for you. Simply select a pickup location 
      nearest to you and enjoy our secure and simple exchange process.  
      We are based in Arlington Heights and proudly serve anyone in or near the area.  
      Take advantage of our exceptional deals and competitive pricing, as we believe everyone should have access to quality cannabis regardless of budget.  
      We are continually expanding our product selection and pickup locations, and will soon offer additional items beyond cannabis.  
      Enjoy Easy Green, and please consider sharing our website!
    </p>
    <button class="btn" id="closeAbout">Close</button>
  </div>
</div>

<div class="wrap hidden" id="mainWrap">
  <header>
    <h1>Easy Green — Anonymous Cannabis</h1>
    <button class="btn ghost" id="logoutBtn" style="margin-left:auto">Log Out</button>
  </header>
  <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
    <div class="small">(Write this down) Your account code: <span id="acctCode"></span></div>
    <div class="small" style="margin-left:12px">Your referral code: <span id="refCode">--</span></div>
    <div class="small" style="margin-left:12px">You have <span id="ticketCount">0</span> tickets</div>
    <button class="btn" id="helpBtn" style="margin-left:auto">First time help</button>
    <button class="btn ghost" id="aboutUserBtn">About Easy Green</button>
  </div>
  <div class="grid" role="main">
    <section class="card">
      <h2>Products</h2>
      <div class="products" id="productsGrid"></div>
    </section>
    <aside class="card">
      <h2>Cart & Pickup</h2>
      <div>
        <label class="small">Pickup Location</label>
        <select id="locationSelect">
          <option value="Hasbrook Park">Hasbrook Park</option>
          <option value="Virginia Terrace Park">Virginia Terrace Park</option>
          <option value="Frontier Park">Frontier Park</option>
          <option value="Pioneer Park">Pioneer Park</option>
          <option value="Grealish Park">Grealish Park</option>
          <option value="Happiness Park">Happiness Park</option>
          <option value="Greenbrier Park">Greenbrier Park</option>
          <option value="Kimball Hill Park">Kimball Hill Park</option>
          <option value="Centennial Park">Centennial Park</option>
        </select>
      </div>
      <div style="margin-top:12px">
        <div id="cartList"></div>
        <div class="cart-total small" id="cartTotal"></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="purchaseBtn">Purchase</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>
      <div style="margin-top:12px">
        <div class="small">Tickets </div>
        <div id="ticketsArea" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
  <footer> Easy Green only accepts cash payments. </footer>
</div>

<div id="adminScreen">
  <h2>Admin Console</h2>
  <div style="margin-bottom:12px">
    <button class="btn" id="refreshTickets">Refresh Tickets</button>
    <button class="btn ghost" id="closeAdmin">Close Admin</button>
  </div>
  <h3>All Tickets</h3>
  <div id="allTicketsArea"></div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// Part A: Firebase initialization
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global stock cache
let stockCache = {};

// User & Cart Data
let currentUser = null;
let cart = [];
let tickets = [];

// Login Modal Elements
const loginModal = document.getElementById('loginModal');
const loginCodeInput = document.getElementById('loginCode');
const loginBtn = document.getElementById('loginBtn');
const createCodeBtn = document.getElementById('createCodeBtn');
const mainWrap = document.getElementById('mainWrap');

// Part B: Updated renderProducts() to check stockCache
function renderProducts(productsData) {
  const productsGrid = document.getElementById('productsGrid');
  productsGrid.innerHTML = '';
  for (let id in productsData) {
    const product = productsData[id];
    stockCache[id] = product.stock; // sync cache
    const card = document.createElement('div');
    card.className = 'product';
    card.innerHTML = `
      <h3>${product.name}</h3>
      <div class="small">Price: $${product.price}</div>
      <div class="small">Stock: ${product.stock}</div>
      <button class="btn" data-id="${id}" ${product.stock === 'out' ? 'disabled' : ''}>Add to Cart</button>
    `;
    productsGrid.appendChild(card);
  }

  // Button click
  document.querySelectorAll('.product button').forEach(btn => {
    btn.onclick = () => {
      const id = btn.dataset.id;
      if (stockCache[id] === 'out') return;
      const item = { ...productsData[id], id };
      cart.push(item);
      updateCartUI();
    };
  });
}

// Update cart display
function updateCartUI() {
  const cartList = document.getElementById('cartList');
  const cartTotal = document.getElementById('cartTotal');
  cartList.innerHTML = '';
  let total = 0;
  cart.forEach((item, idx) => {
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `<span>${item.name} $${item.price}</span> <button class="btn ghost" data-idx="${idx}">Remove</button>`;
    cartList.appendChild(div);
    total += item.price;
  });
  cartTotal.textContent = `Total: $${total}`;
  document.querySelectorAll('.cart-item button').forEach(btn => {
    btn.onclick = () => {
      const idx = parseInt(btn.dataset.idx);
      cart.splice(idx,1);
      updateCartUI();
    };
  });
}

// Part C: Updated purchaseBtn handler with createRaffleTicket
document.getElementById('purchaseBtn').onclick = async () => {
  if (!currentUser) { alert('Login first'); return; }
  if (cart.length === 0) { alert('Cart is empty'); return; }
  const location = document.getElementById('locationSelect').value;
  const ticketId = await createRaffleTicket(currentUser, cart, location);
  tickets.push(ticketId);
  cart = [];
  updateCartUI();
  renderTickets();
};

// Create raffle ticket
async function createRaffleTicket(user, cartItems, location) {
  const ref = db.ref('raffleTickets').push();
  const ticketData = {
    user,
    items: cartItems,
    location,
    createdAt: Date.now(),
    status: 'pending',
    ticketNumber: null // will assign numeric label in Part E
  };
  await ref.set(ticketData);
  return ref.key;
}

// Clear cart
document.getElementById('clearBtn').onclick = () => { cart = []; updateCartUI(); };

// Fetch products from Firebase
db.ref('products').on('value', snapshot => {
  renderProducts(snapshot.val() || {});
});
</script>
<script>
// --- Login & Account Creation ---
createCodeBtn.onclick = () => {
  const code = 'user-' + Math.random().toString(36).substr(2,6);
  db.ref('users/' + code).set({ created: Date.now() });
  alert('Your new code: ' + code);
  loginCodeInput.value = code;
};

loginBtn.onclick = () => {
  const code = loginCodeInput.value.trim();
  if (!code) { alert('Enter a code'); return; }

  db.ref('users/' + code).once('value', snap => {
    const user = snap.val();
    if (!user) { alert('Invalid code'); return; }
    currentUser = code;
    loginModal.classList.add('hidden');
    mainWrap.classList.remove('hidden');

    // Show warnings if not admin
    if (!user.isAdmin) document.getElementById('warningModal').classList.remove('hidden');

    updateTicketCountUI();
    renderTickets();
  });
};

// --- Warning Modal ---
document.getElementById('ackBtn').onclick = () => {
  if (!document.getElementById('ackCheck').checked) return alert('Check agree');
  document.getElementById('warningModal').classList.add('hidden');
};

// --- Part D: Item Received / Referral Handling ---
function showItemReceived(ticketId) {
  const modalBack = document.createElement('div');
  modalBack.className = 'modal-back';
  modalBack.innerHTML = `
    <div class="modal">
      <h3>Item Received</h3>
      <p>Did a friend refer you?</p>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="yesReferralBtn">Yes</button>
        <button class="btn ghost" id="noReferralBtn">No</button>
      </div>
    </div>
  `;
  document.body.appendChild(modalBack);

  modalBack.querySelector('#noReferralBtn').onclick = () => {
    modalBack.remove();
    db.ref('raffleTickets/' + ticketId).remove();
  };

  modalBack.querySelector('#yesReferralBtn').onclick = () => {
    const entryDiv = document.createElement('div');
    entryDiv.style.marginTop = '12px';
    entryDiv.innerHTML = `
      <label>Enter referral code: <input type="text" id="friendCode"></label>
      <div id="refWarning" style="color:red;font-size:0.85rem;margin-top:4px"></div>
      <button class="btn" id="submitReferral">Submit</button>
    `;
    modalBack.querySelector('.modal').appendChild(entryDiv);

    modalBack.querySelector('#submitReferral').onclick = () => {
      const codeInput = modalBack.querySelector('#friendCode').value.trim();
      const warning = modalBack.querySelector('#refWarning');
      if (!codeInput) return warning.innerText = 'Enter a code';
      if (codeInput === currentUser) return warning.innerText = 'Cannot use your own code';
      // Add raffle ticket to friend
      db.ref('raffleTickets').push({ owner: codeInput, referredBy: currentUser });
      modalBack.remove();
      db.ref('raffleTickets/' + ticketId).remove();
    };
  };
};

// --- Render Tickets ---
function renderTickets() {
  const area = document.getElementById(currentUser === 'user-9e21mr' ? 'allTicketsArea' : 'ticketsArea');
  area.innerHTML = '';
  db.ref('tickets').off();
  db.ref('tickets').on('child_added', snap => {
    const t = snap.val();
    if (!t.user) t.user = '';
    if (currentUser !== 'user-9e21mr' && t.user !== currentUser) return;

    const div = document.createElement('div');
    div.className = 'ticket';
    const itemsText = t.items ? t.items.map(i => `${i.name} (${i.selectedFlavor})`).join(', ') : '';
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total || 0} | Status ${t.status || 'pending'}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        ${currentUser === 'user-9e21mr' ? '<button class="btn ghost itemHiddenBtn">Item Hidden</button>' : ''}
      </div>
    `;
    area.appendChild(div);

    // Messages listener
    const chatEl = div.querySelector('#chat-' + t.id) || document.createElement('div');
    chatEl.style.height = '100px'; chatEl.style.overflow = 'auto';
    db.ref('messages/' + t.id).on('value', ms => {
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m => {
        const displayName = (m.from === 'user-9e21mr' && currentUser !== 'user-9e21mr') ? 'admin' : m.from;
        return `<div><strong>${displayName}:</strong> ${m.text || ''}${m.image ? '<br><img src="'+m.image+'" style="max-width:100px">' : ''}</div>`;
      }).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // Send button
    div.querySelector('.sendBtn').onclick = () => {
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      if (fileInp.files.length > 0) {
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload = e => db.ref('messages/' + t.id).push({ from: currentUser, image: e.target.result });
        reader.readAsDataURL(file);
        fileInp.value = '';
      }
      if (inp.value.trim()) db.ref('messages/' + t.id).push({ from: currentUser, text: inp.value.trim() });
      inp.value = '';
    };

    // Cancel ticket
    div.querySelector('.cancelTicketBtn').onclick = () => {
      if (confirm('Are you sure you want to cancel this ticket?')) {
        db.ref('tickets/' + t.id).remove();
        db.ref('messages/' + t.id).remove();
        div.remove();
      }
    };

    // Mark Paid
    div.querySelector('.markPaidBtn').onclick = () => {
      db.ref('messages/' + t.id).push({ from: currentUser, text: 'Payment hidden. Product will be ready within 24h. Provide photo of hidden payment.' });
    };

    // Admin: Item Hidden
    if (currentUser === 'user-9e21mr') {
      div.querySelector('.itemHiddenBtn').onclick = () => {
        db.ref('messages/' + t.id).push({ from: currentUser, text: 'Item has been hidden. Refer to photos for location.' });
        db.ref('tickets/' + t.id + '/status').set('hidden'); // now admin must click complete order
      };
    }
  });
}
</script>
<script>
// --- Part E: Admin Complete Order Button & initAdminUI ---
function initAdminUI() {
  if (currentUser !== 'user-9e21mr') return;

  // Complete Order button per ticket
  db.ref('tickets').once('value', snap => {
    const tickets = snap.val() || {};
    Object.keys(tickets).forEach(tid => {
      const ticketDiv = document.querySelector(`.ticket div strong:contains("${tid}")`);
      if (!ticketDiv) return;
      let completeBtn = ticketDiv.parentNode.querySelector('.completeOrderBtn');
      if (!completeBtn) {
        completeBtn = document.createElement('button');
        completeBtn.className = 'btn completeOrderBtn';
        completeBtn.innerText = 'Complete Order';
        completeBtn.style.marginLeft = '6px';
        ticketDiv.parentNode.appendChild(completeBtn);
        completeBtn.onclick = () => {
          db.ref('tickets/' + tid + '/status').set('complete');
          // Give raffle ticket to user after complete
          createRaffleTicket(tickets[tid].user);
          completeBtn.style.background = 'green';
        };
      }
    });
  });

  // Admin Raffle Winner Button
  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.innerText = 'Raffle Winner';
  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick = () => {
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();
    modalBack.querySelector('#submitWinnerBtn').onclick = () => {
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if (!winnerCode) return alert('Enter a user code');
      const ticketId = 'raffle-' + Date.now();
      const ticket = {
        id: ticketId,
        total: 0,
        location: 'RAFFLE',
        status: 'winner',
        items: [],
        user: winnerCode
      };
      db.ref('tickets/' + ticketId).set(ticket);
      db.ref('messages/' + ticketId).push({ from: currentUser, text: 'RAFFLE WINNER! You have won the raffle.' });
      alert('Raffle winner ticket created for ' + winnerCode);
      modalBack.remove();
    };
  };
}

// --- Part C: Purchase handler using createRaffleTicket ---
function createRaffleTicket(userCode) {
  db.ref('raffleTickets').once('value', snap => {
    const tickets = snap.val() || {};
    const nextNum = Object.keys(tickets).length + 1;
    db.ref('raffleTickets/ticket-' + nextNum).set({ owner: userCode });
  });
}

purchaseBtn.onclick = () => {
  if (!cart.length) return alert('Empty cart');

  let total = 0, ediblesCount = 0, muhaCount = 0;
  cart.forEach(c => { total += c.price; if (c.name.includes('Edibles')) ediblesCount++; if (c.name.includes('Muha Meds')) muhaCount++; });
  total -= Math.floor(ediblesCount / 4) * 20;
  total -= Math.floor(muhaCount / 2) * 5;

  const ticketId = 'tkt-' + Date.now();
  const ticket = {
    id: ticketId,
    total: total,
    location: locationSelect.value,
    status: 'pending',
    items: cart,
    user: currentUser
  };
  db.ref('tickets/' + ticketId).set(ticket);
  db.ref('messages/' + ticketId).push({ from: currentUser, text: 'Ticket created' });

  // Automatically add raffle ticket for purchaser
  createRaffleTicket(currentUser);

  cart = [];
  renderCart();
};

// --- Part F: renderTicketsWithReceived ---
function renderTicketsWithReceived() {
  const area = document.getElementById('ticketsArea');
  area.innerHTML = '';
  db.ref('tickets').on('child_added', snap => {
    const t = snap.val();
    if (!t.user || t.user !== currentUser) return;

    const div = document.createElement('div'); div.className = 'ticket';
    const itemsText = t.items.map(i => `${i.name} (${i.selectedFlavor})`).join(', ');
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <button class="btn itemReceivedBtn" style="margin-top:6px;background:#ccc" disabled>Item Received</button>
    `;
    area.appendChild(div);

    // Listen if readyForReceived turns true
    db.ref('tickets/' + t.id + '/status').on('value', snap => {
      const val = snap.val();
      const btn = div.querySelector('.itemReceivedBtn');
      if (val === 'complete') { btn.disabled = false; btn.style.background = 'green'; }
      else { btn.disabled = true; btn.style.background = '#ccc'; }
    });

    div.querySelector('.itemReceivedBtn').onclick = () => showItemReceived(t.id);
  });
}

// --- Initialize Admin UI if admin ---
if (currentUser === 'user-9e21mr') initAdminUI();
renderTicketsWithReceived();
updateTicketCountUI();
</script>
</body>
</html>
