<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// ---- Firebase Setup ----
const firebaseConfig = {
  apiKey: "AIzaSyA1JdHEgkIQKzX_FKZKNgLW6YEqAqMiRDo",
  authDomain: "easy-green-website.firebaseapp.com",
  databaseURL: "https://easy-green-website-default-rtdb.firebaseio.com",
  projectId: "easy-green-website",
  storageBucket: "easy-green-website.firebasestorage.app",
  messagingSenderId: "988776675269",
  appId: "1:988776675269:web:f2245f84a726d01f3e3dac",
  measurementId: "G-PR35QWS2T6"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ---- Utility ----
function uid6(){return Math.random().toString(36).slice(2,8).toUpperCase();}
function money(n){return '$'+n.toFixed(2);}

// ---- Global Vars ----
const PRODUCTS=[
  {id:'c1',name:'Edibles',price:20,flavors:['Sour Patch','Skittlez','Swedish Fish','Watermelon','Starburst','Trolli','Peach Rings']},
  {id:'c2',name:'2G Ghost Disposable Carts',price:40,flavors:['Alien Burger','Durban Gushers','Papaya','Ghost Train Haze','Purple Ice cream Cake','Black Mamba']},
];
let account=null;

// ---- Login ----
function showMainSite(){
  document.getElementById('loginModal').classList.add('hidden');
  document.getElementById('mainWrap').classList.remove('hidden');
  document.getElementById('warningModal').classList.remove('hidden');
  document.getElementById('acctCode').textContent=account;
  initSiteScripts();
}

document.getElementById('loginBtn').onclick=()=>{
  const code=document.getElementById('loginCode').value.trim().toUpperCase();
  if(!code){alert('Enter code');return;}
  if(code==="joeygold54"){showAdmin();return;}
  get(ref(db,'codes/'+code)).then(snap=>{
    if(!snap.exists()){alert('Invalid code');return;}
    account=code;showMainSite();
  });
};

document.getElementById('createCodeBtn').onclick=()=>{
  account=uid6();
  set(ref(db,'codes/'+account),true);
  alert('New code: '+account);
  showMainSite();
};

document.getElementById('ackBtn').onclick=()=>{
  if(!document.getElementById('ackCheck').checked){alert('Confirm rules');return;}
  document.getElementById('warningModal').classList.add('hidden');
};

// ---- Help ----
document.getElementById('helpBtn').onclick=()=>{document.getElementById('helpModal').classList.remove('hidden');};
document.getElementById('closeHelp').onclick=()=>{document.getElementById('helpModal').classList.add('hidden');};

// ---- Admin ----
document.getElementById('closeAdmin').onclick=()=>{document.getElementById('adminScreen').style.display='none';};
document.getElementById('refreshTickets').onclick=renderAdminTickets;
function showAdmin(){document.getElementById('adminScreen').style.display='block';renderAdminStock();renderAdminTickets();}

// ---- Site Scripts ----
function initSiteScripts(){
  const grid=document.getElementById('productsGrid');grid.innerHTML='';
  PRODUCTS.forEach(p=>{
    const el=document.createElement('div');el.className='product';
    el.innerHTML=`<h3>${p.name}</h3>
      <div class="small">Price: ${money(p.price)}</div>
      <label>Flavor<select class="flavorSelect">${p.flavors.map(f=>`<option>${f}</option>`).join('')}</select></label>
      <label>Qty<input type="number" min="1" value="1" class="qtyInput" style="width:70px"></label>
      <div style="margin-top:8px"><button class="btn addBtn">Add</button></div>`;
    grid.appendChild(el);
    el.querySelector('.addBtn').addEventListener('click',()=>{
      const flavor=el.querySelector('.flavorSelect').value;
      const qty=Number(el.querySelector('.qtyInput').value)||1;
      const item={productId:p.id,name:p.name,flavor,qty,price:p.price};
      push(ref(db,`carts/${account}`),item);
      alert('Added to cart');
    });
  });

  // realtime cart + tickets
  onValue(ref(db,`carts/${account}`),(snap)=>{
    const cartList=document.getElementById('cartList');
    const cartTotalEl=document.getElementById('cartTotal');
    cartList.innerHTML='';
    let total=0;
    if(!snap.exists()){cartList.innerHTML='<div class="small">Cart empty.</div>';cartTotalEl.textContent='';return;}
    snap.forEach(child=>{
      const it=child.val();total+=it.price*it.qty;
      const div=document.createElement('div');div.className='cart-item';
      div.innerHTML=`<div><div style="font-weight:600">${it.name} ×${it.qty}</div><div class="small">${it.flavor}</div></div>
        <div style="text-align:right"><div>${money(it.price*it.qty)}</div>
        <button class="btn ghost" onclick="removeCart('${child.key}')">Remove</button></div>`;
      cartList.appendChild(div);
    });
    cartTotalEl.textContent=`Total: ${money(total)}`;
  });

  document.getElementById('purchaseBtn').onclick=()=>{
    get(ref(db,`carts/${account}`)).then(snap=>{
      if(!snap.exists()){alert('Cart empty');return;}
      const items=[];let total=0;
      snap.forEach(c=>{items.push(c.val());total+=c.val().price*c.val().qty;});
      const loc=document.getElementById('locationSelect').value;
      const tid='T-'+uid6();
      set(ref(db,`tickets/${account}/${tid}`),{
        id:tid,account,location:loc,items,total,status:'open',
        messages:[{from:'System',text:`Ticket created. Total ${money(total)}. Hide payment at ${loc}.`}]
      });
      remove(ref(db,`carts/${account}`));
      alert('Ticket created: '+tid);
    });
  };
  document.getElementById('clearBtn').onclick=()=>{remove(ref(db,`carts/${account}`));};

  onValue(ref(db,`tickets/${account}`),(snap)=>{
    const ticketsArea=document.getElementById('ticketsArea');ticketsArea.innerHTML='';
    if(!snap.exists()){ticketsArea.innerHTML='<div class="small">No tickets yet.</div>';return;}
    snap.forEach(child=>{
      const t=child.val();
      const el=document.createElement('div');el.className='card';el.style.marginBottom='8px';
      el.innerHTML=`<div style="display:flex;justify-content:space-between">
        <div><strong>Ticket ${t.id}</strong> <span class="small">(${t.status})</span></div>
        <div class="small">${t.location}</div></div>
        <div class="small">${t.items.map(i=>`${i.name} ×${i.qty} (${i.flavor})`).join(' • ')}</div>
        <div class="ticket">${(t.messages||[]).map(m=>m.image?`<div><strong>${m.from}:</strong><br><img src="${m.image}" style="max-width:100px">`:`<div><strong>${m.from}:</strong> ${m.text}</div>`).join('')}</div>
        <input type="text" id="msg-${t.id}" placeholder="Send message">
        <input type="file" id="file-${t.id}" accept="image/*">
        <button class="btn" onclick="sendUserMsg('${t.id}')">Send</button>
        <button class="btn ghost" onclick="markPaid('${t.id}')">Mark Paid</button>
        <button class="btn ghost" onclick="cancelOrder('${t.id}')">Cancel</button>`;
      ticketsArea.appendChild(el);
    });
  });
}

// ---- User actions ----
window.removeCart=(key)=>{remove(ref(db,`carts/${account}/${key}`));};

window.sendUserMsg=(tid)=>{
  const msgEl=document.getElementById('msg-'+tid);
  const fileEl=document.getElementById('file-'+tid);
  const tRef=ref(db,`tickets/${account}/${tid}/messages`);
  if(fileEl.files[0]){
    const reader=new FileReader();
    reader.onload=e=>push(tRef,{from:'User',image:e.target.result});
    reader.readAsDataURL(fileEl.files[0]);
  }
  if(msgEl.value.trim()){push(tRef,{from:'User',text:msgEl.value.trim()});msgEl.value='';}
};

window.markPaid=(tid)=>{
  update(ref(db,`tickets/${account}/${tid}`),{status:'paid'});
};

window.cancelOrder=(tid)=>{remove(ref(db,`tickets/${account}/${tid}`));};

// ---- Admin rendering ----
function renderAdminStock(){
  const area=document.getElementById('adminStockArea');area.innerHTML='';
  PRODUCTS.forEach(p=>{
    const card=document.createElement('div');card.className='card';card.innerHTML=`<strong>${p.name}</strong>`;
    p.flavors.forEach(f=>{
      const chk=document.createElement('input');chk.type='checkbox';chk.checked=true;
      const label=document.createElement('label');label.append(chk,document.createTextNode(' '+f));
      card.appendChild(label);
    });
    area.appendChild(card);
  });
}

function renderAdminTickets(){
  const allTicketsArea=document.getElementById('allTicketsArea');allTicketsArea.innerHTML='';
  onValue(ref(db,'tickets'),(snap)=>{
    allTicketsArea.innerHTML='';
    if(!snap.exists()){allTicketsArea.innerHTML='<div class="small">No tickets.</div>';return;}
    snap.forEach(user=>{
      user.forEach(child=>{
        const t=child.val();
        const div=document.createElement('div');div.className='card';div.innerHTML=`
          <div style="font-weight:600">Ticket ${t.id} | ${t.account} | ${t.location} | ${t.status}</div>
          <div class="small">${t.items.map(i=>i.name+' ×'+i.qty+' ('+i.flavor+')').join(' • ')}</div>
          <div class="ticket">${(t.messages||[]).map(m=>m.image?`<div><strong>${m.from}:</strong><br><img src="${m.image}" style="max-width:100px">`:`<div><strong>${m.from}:</strong> ${m.text}</div>`).join('')}</div>
          <input id="adminMsg-${t.id}" placeholder="Admin message">
          <input type="file" id="adminFile-${t.id}" accept="image/*">
          <button class="btn" onclick="sendAdmin('${t.account}','${t.id}')">Send</button>
          <button class="btn ghost" onclick="deleteOrder('${t.account}','${t.id}')">Delete</button>`;
        allTicketsArea.appendChild(div);
      });
    });
  });
}

window.sendAdmin=(acc,tid)=>{
  const msgEl=document.getElementById('adminMsg-'+tid);
  const fileEl=document.getElementById('adminFile-'+tid);
  const tRef=ref(db,`tickets/${acc}/${tid}/messages`);
  if(fileEl.files[0]){
    const reader=new FileReader();
    reader.onload=e=>push(tRef,{from:'Admin',image:e.target.result});
    reader.readAsDataURL(fileEl.files[0]);
  }
  if(msgEl.value.trim()){push(tRef,{from:'Admin',text:msgEl.value.trim()});msgEl.value='';}
};

window.deleteOrder=(acc,tid)=>{remove(ref(db,`tickets/${acc}/${tid}`));};
</script>


