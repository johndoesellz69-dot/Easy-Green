<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Easy Green</title>
<style>
:root{--accent:#2f9c4a;--muted:#6b7280;--card:#fff;--bg:#f6fff6;--maxw:980px}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:linear-gradient(#f6fff6,#eefef0);color:#111}
.wrap{max-width:var(--maxw);margin:18px auto;padding:16px}
header{display:flex;gap:12px;align-items:center}
header h1{margin:0;color:var(--accent);font-size:1.3rem}
.grid{display:grid;grid-template-columns:1fr 320px;gap:14px;margin-top:12px}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 20px rgba(20,60,20,.06)}
.products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.product{border:1px solid #eee;padding:10px;border-radius:10px}
.product h3{margin:6px 0 4px}
.row{display:flex;gap:8px;align-items:center}
label{font-size:.92rem}
select,input[type="number"],input[type="file"]{padding:6px;border-radius:8px;border:1px solid #ddd}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.ghost{background:#f3f3f3;color:#111}
.small{font-size:.88rem;color:var(--muted)}
.cart-item{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #eee}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{width:100%;max-width:760px;background:white;padding:16px;border-radius:12px}
.ticket{background:#fbfff9;border:1px dashed #e6f4ea;padding:10px;border-radius:8px;margin-bottom:6px}
.ticket-entry{margin-bottom:8px}
footer{margin-top:12px;color:var(--muted);font-size:.82rem}
.hidden{display:none !important;}
#adminScreen{position:fixed;inset:0;background:rgba(0,0,0,.95);color:#111;padding:16px;overflow:auto;display:none;z-index:3000}
#adminScreen h2{margin-top:0;color:var(--accent)}
select option[disabled] { color: #999; }
</style>
</head>
<body>
<div id="loginModal" class="modal-back">
  <div class="modal">
    <h3>Login</h3>
    <div style="margin-bottom:12px">
      <label>Enter your login code or Create Account if new: <input type="text" id="loginCode"></label>
      <div class="loginNotice">(Login codes are case-sensitive. Ensure the 'user' part is lowercase. EX: user-123abc)</div>
    </div>
    <div style="margin-bottom:12px">or <button class="btn" id="createCodeBtn">Create new code</button></div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button class="btn" id="loginBtn">Login</button>
    </div>
    <div style="margin-top:8px;display:flex;justify-content:flex-end">
      <button class="btn ghost" id="aboutLoginBtn">About Easy Green</button>
    </div>
  </div>
</div>

<div id="warningModal" class="modal-back hidden">
  <div class="modal">
    <h3>Warnings & Rules</h3>
    <ul>
      <li>Easy Green is not liable for any stolen Product/Payments.</li>
      <li>Use products safely.</li>
      <li>Respect site anonymity.</li>
    </ul>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ackCheck"> I agree
      </label>
      <button class="btn" id="ackBtn">Confirm</button>
    </div>
  </div>
</div>

<div id="helpModal" class="modal-back hidden">
  <div class="modal">
    <h3>First Time Help</h3>
    <p>Welcome to Easy Green! Here's how it works:</p>
    <ol>
      <li>Select products and flavors you want.</li>
      <li>Add items to your cart and choose pickup location.</li>
      <li>Click Purchase to generate a ticket for your order.</li>
      <li>Use the chat under your ticket to send messages or images to admin.</li>
      <li>Admin can respond and send images back.</li>
      <li>Place the specified cash amount in an Envelope and hide it.</li>
      <li>Mark as paid and send a photo of your envelope and the cash inside.</li>
      <li>Admin will message you with item retrieval details after your payment is collected.</li>
      <li>TIPS: It is recommended to hide payments out of the publics view and way, and ensure nobody sees you hiding your payment.</li>
    </ol>
    <button class="btn" id="closeHelp">Got it!</button>
  </div>
</div>

<div id="aboutModal" class="modal-back hidden">
  <div class="modal">
    <h3>About Easy Green</h3>
    <p>
      Welcome to Easy Green! We are proud to be the only local Cannabis service that is fully anonymous. 
      If you wish to obtain cannabis discreetly—without meeting a random sketchy dealer in person, or if you 
      do not have access to a nearby dispensary—Easy Green is here for you. Simply select a pickup location 
      nearest to you and enjoy our secure and simple exchange process.  
      We are based in Arlington Heights and proudly serve anyone in or near the area.  
      Take advantage of our exceptional deals and competitive pricing, as we believe everyone should have access to quality cannabis regardless of budget.  
      We are continually expanding our product selection and pickup locations, and will soon offer additional items beyond cannabis.  
      Enjoy Easy Green, and please consider sharing our website!
    </p>
    <button class="btn" id="closeAbout">Close</button>
  </div>
</div>
<div class="wrap">

  <header>
    <h1>Easy Green</h1>
    <button class="btn" id="helpBtn">Help</button>
    <button class="btn" id="adminLoginBtn">Admin Login</button>
  </header>

  <div class="grid">
    <div>
      <div class="card">
        <h2>Products</h2>
        <div id="productsContainer" class="products">
          <!-- Products will be rendered here via JS -->
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Cart</h2>
        <div id="cartContainer">
          <!-- Cart items rendered here -->
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn" id="purchaseBtn">Purchase</button>
        </div>
      </div>
    </div>

    <div id="adminScreen" class="hidden">
      <h2>Admin Panel</h2>
      <div id="raffleWinnerSection" style="margin-bottom:12px">
        <input type="text" id="winnerUsername" placeholder="Username for raffle winner">
        <button class="btn" id="raffleWinnerBtn">Create Raffle Winner</button>
      </div>
      <div id="ticketsContainer">
        <!-- Admin tickets rendered here -->
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>

<script>
// ===== Firebase Initialization (Part A) =====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_MSG_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== Stock Cache =====
let stockCache = {}; // keeps track of products stock
<script>
// ===== Products Array =====
const products = [
  {id:'bud1', name:'Edibles (Buy 3 get 1 free)', price:20,
    flavors:['Sour Patch','Skittles','Swedish Fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']},
  {id:'cart1', name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)', price:30,
    flavors:['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple']}
];

// ===== Render Products (Part B) =====
function renderProducts(){
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';

  products.forEach(p=>{
    const stockStatus = stockCache[p.id] || 'in';
    const card = document.createElement('div');
    card.className = 'product card';
    if(stockStatus==='out'){
      card.style.opacity = 0.4;
    }

    const title = document.createElement('h3');
    title.innerText = p.name;
    const price = document.createElement('div');
    price.innerText = `$${p.price}`;

    const select = document.createElement('select');
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'Select Flavor';
    select.appendChild(defaultOpt);
    p.flavors.forEach(f=>{
      const opt = document.createElement('option');
      opt.value = f;
      opt.textContent = f;
      select.appendChild(opt);
    });
    select.disabled = (stockStatus==='out');

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.innerText = 'Add';
    btn.disabled = (stockStatus==='out');
    btn.onclick = ()=>{
      if(!select.value) return alert('Select a flavor');
      cart.push({...p, selectedFlavor: select.value});
      renderCart();
    };

    card.appendChild(title);
    card.appendChild(price);
    card.appendChild(select);
    card.appendChild(btn);

    container.appendChild(card);
  });
}

// ===== Cart Handling =====
let cart = [];

function renderCart(){
  const cartContainer = document.getElementById('cartContainer');
  cartContainer.innerHTML = '';
  if(cart.length===0){ cartContainer.innerHTML='<em>Cart is empty</em>'; return; }

  let total=0, ediblesCount=0, muhaCount=0;
  cart.forEach(item=>{
    if(item.name.includes('Edibles')) ediblesCount++;
    if(item.name.includes('Muha Meds')) muhaCount++;
    total += item.price;
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerText = `${item.name} (${item.selectedFlavor}) - $${item.price}`;
    cartContainer.appendChild(row);
  });

  // Apply discounts
  total -= Math.floor(ediblesCount/4)*20;
  total -= Math.floor(muhaCount/2)*5;

  const totalDiv = document.createElement('div');
  totalDiv.style.fontWeight='bold';
  totalDiv.style.marginTop='8px';
  totalDiv.innerText = `Total: $${total}`;
  cartContainer.appendChild(totalDiv);
}

// ===== Purchase Handler (Part C) =====
document.getElementById('purchaseBtn').onclick = ()=>{
  if(cart.length===0) return alert('Cart is empty');

  const ticketId = 'tkt-'+Date.now();
  let total=0, ediblesCount=0, muhaCount=0;
  cart.forEach(item=>{
    total += item.price;
    if(item.name.includes('Edibles')) ediblesCount++;
    if(item.name.includes('Muha Meds')) muhaCount++;
  });
  total -= Math.floor(ediblesCount/4)*20;
  total -= Math.floor(muhaCount/2)*5;

  const ticket = {
    id: ticketId,
    user: currentUser,
    items: [...cart],
    total,
    status: 'pending',
    location: 'default',
    created: Date.now()
  };

  db.ref('tickets/'+ticketId).set(ticket);
  db.ref('messages/'+ticketId).push({from: currentUser, text:'Ticket created'});

  // Auto-create raffle ticket for this purchase
  createRaffleTicket(currentUser);

  cart = [];
  renderCart();
  renderTickets(); // refresh UI
}

// ===== Raffle Ticket Generator =====
function createRaffleTicket(user){
  db.ref('raffleTickets').push({owner: user, timestamp: Date.now()});
}

// ===== Load Stock from Firebase =====
db.ref('products').on('value', snap=>{
  const stock = snap.val() || {};
  stockCache = stock;
  renderProducts();
});

</script><script>
// ===== Ticket Rendering =====
function renderTickets(){
  const area = currentUserIsAdmin ? document.getElementById('allTicketsArea') : document.getElementById('ticketsArea');
  area.innerHTML = '';

  db.ref('tickets').off();
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.id) t.id = snap.key;
    if(!t.user) t.user = '';

    if(!currentUserIsAdmin && t.user !== currentUser) return;

    const itemsText = t.items.map(i=>`${i.name} (${i.selectedFlavor})`).join(', ');
    const div = document.createElement('div');
    div.className = 'ticket';
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:100px;overflow:auto;border-top:1px dashed #ddd;margin-top:4px;padding-top:4px"></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        ${currentUserIsAdmin ? '<button class="btn ghost itemHiddenBtn">Item Hidden</button>' : ''}
        ${currentUserIsAdmin ? '<button class="btn ghost completeOrderBtn" style="background:#ccc">Complete Order</button>' : ''}
      </div>
    `;
    area.appendChild(div);

    // ===== Chat Binding =====
    const chatEl = document.getElementById('chat-'+t.id);
    db.ref('messages/'+t.id).off();
    db.ref('messages/'+t.id).on('value', ms=>{
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m=>{
        const displayName = (m.from==='user-9e21mr' && currentUser!=='user-9e21mr') ? 'admin' : m.from;
        return `<div><strong>${displayName}:</strong> ${m.text||''}${m.image?'<br><img src="'+m.image+'" style="max-width:100px">':''}</div>`;
      }).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // ===== Send Message =====
    div.querySelector('.sendBtn').onclick = ()=>{
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      if(fileInp.files.length>0){
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload = function(e){
          db.ref('messages/'+t.id).push({from:currentUser,image:e.target.result});
        };
        reader.readAsDataURL(file);
        fileInp.value='';
      }
      if(inp.value.trim()) db.ref('messages/'+t.id).push({from:currentUser,text:inp.value.trim()});
      inp.value='';
    };

    // ===== Cancel Ticket =====
    div.querySelector('.cancelTicketBtn').onclick = ()=>{
      if(confirm('Are you sure you want to cancel this ticket?')){
        db.ref('tickets/'+t.id).remove();
        db.ref('messages/'+t.id).remove();
        div.remove();
      }
    };

    // ===== Mark Paid =====
    div.querySelector('.markPaidBtn').onclick = ()=>{
      db.ref('messages/'+t.id).push({from:currentUser,text:'Payment hidden. Your product will be securely hidden and ready for pickup within 24 hours. Please provide photo of hidden payment and location info.'});
    };

    // ===== Admin Item Hidden =====
    if(currentUserIsAdmin){
      div.querySelector('.itemHiddenBtn').onclick = ()=>{
        db.ref('messages/'+t.id).push({from:currentUser,text:'Item has been hidden. Admin will complete order when retrieved.'});
        db.ref('tickets/'+t.id+'/status').set('hidden');
        // Turn Complete Order button green
        const completeBtn = div.querySelector('.completeOrderBtn');
        completeBtn.style.background = 'green';
      };

      // ===== Admin Complete Order =====
      div.querySelector('.completeOrderBtn').onclick = ()=>{
        db.ref('tickets/'+t.id+'/status').set('complete');
        createRaffleTicket(t.user); // Give raffle ticket to user
        div.querySelector('.completeOrderBtn').style.background = '#ccc';
      };
    }
  });
}

// ===== Initial Call =====
renderTickets();
</script>
<script>
// ===== Admin Raffle Winner Button =====
function initAdminRaffleButton(){
  if(!currentUserIsAdmin) return;

  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.innerText = 'Raffle Winner';
  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick = () => {
    // Create modal for entering user code
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();

    modalBack.querySelector('#submitWinnerBtn').onclick = () => {
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if(!winnerCode) return alert('Enter a user code');

      // Generate a simple raffle ticket number (incremental)
      let nextRaffleNumber = 1;
      db.ref('raffleTickets').once('value', snap=>{
        const allTickets = snap.val() || {};
        const numbers = Object.values(allTickets).map(t=>t.number || 0);
        if(numbers.length) nextRaffleNumber = Math.max(...numbers) + 1;

        // Create raffle ticket
        const ticketId = 'raffle-' + Date.now();
        const ticket = {
          id: ticketId,
          total: 0,
          location: 'RAFFLE',
          status: 'winner',
          items: [],
          user: winnerCode
        };
        db.ref('tickets/' + ticketId).set(ticket);
        db.ref('messages/' + ticketId).push({from: currentUser, text: 'RAFFLE WINNER! You have won the raffle.'});
        db.ref('raffleTickets').push({owner: winnerCode, number: nextRaffleNumber});

        alert('Raffle winner ticket created for ' + winnerCode + ' (#' + nextRaffleNumber + ')');
        modalBack.remove();
      });
    };
  };
}

// ===== Call it after admin login =====
if(currentUserIsAdmin){
  initAdminRaffleButton();
}
</script>
<script>
// ===== Product Rendering with Stock Check =====
let stockCache = {}; // Cache Firebase stock status for quick reference

function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  // Sample products (same as original)
  const sample = [
    {
      id:'bud1',
      name:'Edibles (Buy 3 get 1 free)',
      price:20,
      flavors:['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']
    },
    {
      id:'cart1',
      name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)',
      price:30,
      flavors:['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple']
    }
  ];

  // Get stock data from Firebase
  db.ref('stock').once('value',snap=>{
    stockCache = snap.val() || {};

    sample.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'product';

      const title = document.createElement('h3');
      title.textContent = p.name;

      const priceDiv = document.createElement('div');
      priceDiv.textContent = `$${p.price}`;

      const select = document.createElement('select');
      const defOpt = document.createElement('option');
      defOpt.value='';
      defOpt.textContent='Select Flavor';
      select.appendChild(defOpt);

      p.flavors.forEach(f=>{
        const option = document.createElement('option');
        option.value = f;
        option.textContent = f;
        select.appendChild(option);
      });

      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Add';

      // Disable button if out of stock
      const isOutOfStock = stockCache[p.id] === 'out';
      if(isOutOfStock){
        btn.disabled = true;
        btn.textContent = 'Out of Stock';
      }

      btn.onclick = () => {
        const flavor = select.value || 'None';
        if(!flavor) return alert('Select a flavor');
        if(isOutOfStock) return alert('This product is currently out of stock.');
        cart.push({...p,selectedFlavor:flavor});
        renderCart();
      };

      div.appendChild(title);
      div.appendChild(priceDiv);
      div.appendChild(select);
      div.appendChild(btn);

      grid.appendChild(div);
    });
  });
}
</script>
<script>
// ===== Render Tickets (User + Admin) =====
function renderTickets(){
  const area = document.getElementById(currentUserIsAdmin ? 'allTicketsArea' : 'ticketsArea');
  area.innerHTML = '';

  // Stop previous Firebase listeners
  db.ref('tickets').off();

  // Listen for all tickets
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.id) t.id = snap.key;
    if(!t.user) t.user = '';

    // Users only see their own tickets
    if(!currentUserIsAdmin && t.user !== currentUser) return;

    const itemsText = (t.items || []).map(i=>`${i.name} (${i.selectedFlavor})`).join(', ');

    const div = document.createElement('div');
    div.className = 'ticket';
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:100px;overflow:auto;border-top:1px dashed #ddd;margin-top:4px;padding-top:4px"></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        ${currentUserIsAdmin?'<button class="btn ghost itemHiddenBtn">Item Hidden</button>':''}
      </div>
    `;
    area.appendChild(div);

    // Load messages for this ticket
    const chatEl = document.getElementById('chat-'+t.id);
    db.ref('messages/'+t.id).off();
    db.ref('messages/'+t.id).on('value', ms=>{
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m=>{
        const displayName = (m.from === 'user-9e21mr' && currentUser !== 'user-9e21mr') ? 'admin' : m.from;
        return `<div><strong>${displayName}:</strong> ${m.text||''}${m.image?'<br><img src="'+m.image+'" style="max-width:100px">':''}</div>`;
      }).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // Send message button
    div.querySelector('.sendBtn').onclick = ()=>{
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      const txt = inp.value.trim();

      if(fileInp.files.length > 0){
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload = function(e){
          db.ref('messages/'+t.id).push({from: currentUser, image: e.target.result});
        };
        reader.readAsDataURL(file);
        fileInp.value = '';
      }

      if(txt) db.ref('messages/'+t.id).push({from: currentUser, text: txt});
      inp.value = '';
    };

    // Cancel ticket button
    div.querySelector('.cancelTicketBtn').onclick = ()=>{
      if(confirm('Are you sure you want to cancel this ticket?')){
        db.ref('tickets/'+t.id).remove();
        db.ref('messages/'+t.id).remove();
        div.remove();
      }
    };

    // Mark paid button
    div.querySelector('.markPaidBtn').onclick = ()=>{
      db.ref('messages/'+t.id).push({
        from: currentUser,
        text: 'Payment hidden. Your product will be securely hidden and ready for pickup within 24 hours, please also provide photo of hidden payment and any location information.'
      });
    };

    // Admin: Item hidden
    if(currentUserIsAdmin){
      div.querySelector('.itemHiddenBtn').onclick = ()=>{
        db.ref('messages/'+t.id).push({
          from: currentUser,
          text: 'Item has been hidden. Refer to photos below for location of item. Have fun and practice safe usage.'
        });
        db.ref('tickets/'+t.id+'/status').set('complete');
      };
    }
  });
}

// Refresh tickets
document.getElementById('refreshTickets').onclick = renderTickets;
document.getElementById('closeAdmin').onclick = ()=>document.getElementById('adminScreen').style.display='none';
</script>
<script>
// ===== Admin UI Buttons =====
function initAdminUI(){
  // Complete Order Button
  const compBtn = document.createElement('button');
  compBtn.className = 'btn';
  compBtn.innerText = 'Complete Order';
  const allTicketsParent = document.getElementById('allTicketsArea').parentNode;
  allTicketsParent.insertBefore(compBtn, document.getElementById('allTicketsArea'));

  compBtn.onclick = ()=>{
    // Set all tickets readyForReceived
    db.ref('tickets').once('value', snap=>{
      const tickets = snap.val() || {};
      Object.keys(tickets).forEach(tid=>{
        db.ref('tickets/'+tid+'/readyForReceived').set(true);
      });
    });
  };

  // Raffle Winner Button
  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.innerText = 'Raffle Winner';
  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick = ()=>{
    // Create modal for entering user code
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = ()=> modalBack.remove();

    modalBack.querySelector('#submitWinnerBtn').onclick = ()=>{
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if(!winnerCode) return alert('Enter a user code');

      // Create raffle ticket with number sequence
      db.ref('raffleTickets').once('value', snap=>{
        const allTickets = snap.val() || {};
        const nextNum = Object.keys(allTickets).length + 1;

        const ticketId = 'raffle-' + nextNum;
        db.ref('tickets/' + ticketId).set({
          id: ticketId,
          total: 0,
          location: 'RAFFLE',
          status: 'winner',
          items: [],
          user: winnerCode
        });
        db.ref('messages/' + ticketId).push({
          from: currentUser,
          text: 'RAFFLE WINNER! You have won the raffle.'
        });
        alert('Raffle winner ticket created for ' + winnerCode);
        modalBack.remove();
      });
    };
  };
}

// Call initAdminUI after admin login
if(currentUserIsAdmin){
  document.getElementById('adminScreen').style.display = 'block';
  initAdminUI();
}
</script>
<script>
// ===== Products & Stock Handling =====
let stockCache = {}; // Cache to track stock status

// Load stock from Firebase once at login
db.ref('stock').on('value', snap=>{
  stockCache = snap.val() || {};
  renderProducts(); // Re-render products when stock changes
});

function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  const sample = [
    {id:'bud1',name:'Edibles (Buy 3 get 1 free)',price:20,flavors:['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']},
    {id:'cart1',name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)',price:30,flavors:['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple']}
  ];

  sample.forEach(p=>{
    // Check if product is out of stock
    const isOut = stockCache[p.id] === 'out';

    const div = document.createElement('div');
    div.className = 'product';
    if(isOut) div.style.opacity = '0.4';

    const title = document.createElement('h3');
    title.textContent = p.name;

    const priceDiv = document.createElement('div');
    priceDiv.textContent = `$${p.price}`;

    const select = document.createElement('select');
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = isOut ? 'Out of Stock' : 'Select Flavor';
    if(isOut) defOpt.disabled = true;
    select.appendChild(defOpt);

    p.flavors.forEach(f=>{
      const option = document.createElement('option');
      option.value = f;
      option.textContent = f;
      if(isOut) option.disabled = true;
      select.appendChild(option);
    });

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Add';
    btn.disabled = isOut;
    btn.onclick = ()=>{
      const flavor = select.value || 'None';
      if(!flavor) return alert('Select a flavor');
      cart.push({...p, selectedFlavor: flavor});
      renderCart();
    };

    div.appendChild(title);
    div.appendChild(priceDiv);
    div.appendChild(select);
    div.appendChild(btn);

    grid.appendChild(div);
  });
}
</script>
<script>
// ===== Admin Tickets & Chat =====
function renderAdminTickets(){
  const area = document.getElementById('allTicketsArea');
  area.innerHTML = '';

  // Listen for all tickets in Firebase
  db.ref('tickets').off(); // Remove previous listeners
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.id) t.id = snap.key;
    if(!t.user) t.user = '';

    const itemsText = t.items.map(i=>`${i.name} (${i.selectedFlavor})`).join(', ');
    const div = document.createElement('div');
    div.className = 'ticket';
    div.innerHTML = `
      <div><strong>${t.id}</strong> - ${t.user} @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:100px;overflow:auto;border-top:1px dashed #ddd;margin-top:4px;padding-top:4px"></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        <button class="btn ghost itemHiddenBtn">Item Hidden</button>
      </div>
    `;
    area.appendChild(div);

    const chatEl = document.getElementById('chat-'+t.id);

    // Listen for messages on this ticket
    db.ref('messages/'+t.id).off();
    db.ref('messages/'+t.id).on('value', ms=>{
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m=>{
        const displayName = (m.from==='user-9e21mr' && currentUser!=='user-9e21mr')?'admin':m.from;
        return `<div><strong>${displayName}:</strong> ${m.text||''}${m.image?'<br><img src="'+m.image+'" style="max-width:100px">':''}</div>`;
      }).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // Button handlers
    div.querySelector('.sendBtn').onclick = ()=>{
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      const txt = inp.value.trim();

      if(fileInp.files.length > 0){
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload = function(e){
          db.ref('messages/'+t.id).push({from: currentUser, image:e.target.result});
        };
        reader.readAsDataURL(file);
        fileInp.value = '';
      }

      if(txt) db.ref('messages/'+t.id).push({from: currentUser, text: txt});
      inp.value='';
    };

    div.querySelector('.cancelTicketBtn').onclick = ()=>{
      if(confirm('Are you sure you want to cancel this ticket?')){
        db.ref('tickets/'+t.id).remove();
        db.ref('messages/'+t.id).remove();
        div.remove();
      }
    };

    div.querySelector('.markPaidBtn').onclick = ()=>{
      db.ref('messages/'+t.id).push({from: currentUser, text:'Payment hidden. Product will be ready for pickup within 24 hours, provide photo of hidden payment.'});
    };

    div.querySelector('.itemHiddenBtn').onclick = ()=>{
      db.ref('messages/'+t.id).push({from: currentUser, text:'Item has been hidden. Refer to photos for location. Have fun and practice safe usage.'});
      db.ref('tickets/'+t.id+'/status').set('complete');
      // Mark ticket as ready for user "Item Received" button
      db.ref('tickets/'+t.id+'/readyForReceived').set(true);
    };
  });
}

// Call this after admin login
function initAdminUI(){
  if(currentUserIsAdmin){
    renderAdminTickets();
  }
}
</script>
<script>
// ===== Admin Raffle Winner Button =====
function initRaffleWinnerButton(){
  if(!currentUserIsAdmin) return;

  // Only add once
  if(document.getElementById('raffleWinnerBtn')) return;

  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.id = 'raffleWinnerBtn';
  raffleBtn.innerText = 'Raffle Winner';

  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick = ()=>{
    // Create modal for entering user code
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();

    modalBack.querySelector('#submitWinnerBtn').onclick = ()=>{
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if(!winnerCode) return alert('Enter a user code');

      // Create special ticket labeled "RAFFLE WINNER"
      const ticketId = 'raffle-' + Date.now();
      const ticket = {
        id: ticketId,
        total: 0,
        location: 'RAFFLE',
        status: 'winner',
        items: [],
        user: winnerCode
      };

      db.ref('tickets/' + ticketId).set(ticket);
      db.ref('messages/' + ticketId).push({from: currentUser, text:'RAFFLE WINNER! You have won the raffle.'});

      alert('Raffle winner ticket created for ' + winnerCode);
      modalBack.remove();
    };
  };
}

// Call this after admin login
function initAdminUIExtras(){
  initRaffleWinnerButton();
}
</script>
<script>
// ===== Render Products with Stock =====
let stockCache = {}; // Cache for Firebase stock

// Fetch stock from Firebase and store locally
db.ref('stock').on('value', snap=>{
  stockCache = snap.val() || {};
  renderProducts();
});

function renderProducts(){
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = '';

  // Original product list
  const sample = [
    {id:'bud1',name:'Edibles (Buy 3 get 1 free)',price:20,flavors:['Sour Patch','Skittles','Swedish fish','Watermelon Sour Patch','Starburst','Trolli','Peach Rings']},
    {id:'cart1',name:'2g Muha Meds Carts (Buy 1 get 1 $5 off)',price:30,flavors:['Sugar Daddy Punch','Pineapple Runtz','Blueberry Muffin','Blue Slushie','Candy Apple']}
  ];

  sample.forEach(p=>{
    // Skip if stock is "out"
    if(stockCache[p.id] === 'out') return;

    const div = document.createElement('div');
    div.className = 'product';

    const title = document.createElement('h3');
    title.textContent = p.name;

    const priceDiv = document.createElement('div');
    priceDiv.textContent = `$${p.price}`;

    const select = document.createElement('select');
    const defOpt = document.createElement('option');
    defOpt.value = '';
    defOpt.textContent = 'Select Flavor';
    select.appendChild(defOpt);

    p.flavors.forEach(f=>{
      const option = document.createElement('option');
      option.value = f;
      option.textContent = f;
      select.appendChild(option);
    });

    const btn = document.createElement('button');
    btn.className = 'btn';
    btn.textContent = 'Add';
    btn.onclick = ()=>{
      const flavor = select.value || 'None';
      if(!flavor) return alert('Select a flavor');
      cart.push({...p, selectedFlavor: flavor});
      renderCart();
    };

    div.appendChild(title);
    div.appendChild(priceDiv);
    div.appendChild(select);
    div.appendChild(btn);

    grid.appendChild(div);
  });
}
</script>
<script>
// ===== Render Tickets (User + Admin) with Complete Order =====
function renderTickets(){
  const area = document.getElementById(currentUserIsAdmin ? 'allTicketsArea' : 'ticketsArea');
  area.innerHTML = '';

  db.ref('tickets').off(); // Remove previous listeners
  db.ref('tickets').on('child_added', snap=>{
    const t = snap.val();
    if(!t.id) t.id = snap.key;
    if(!t.user) t.user = '';

    // Skip if user is not admin and ticket does not belong to them
    if(!currentUserIsAdmin && t.user !== currentUser) return;

    const itemsText = t.items.map(i=>`${i.name} (${i.selectedFlavor})`).join(', ');
    const div = document.createElement('div');
    div.className = 'ticket';
    div.innerHTML = `
      <div><strong>${t.id}</strong> @ ${t.location} | Total $${t.total} | Status ${t.status}</div>
      <div><em>Items: ${itemsText}</em></div>
      <div id="chat-${t.id}" style="height:100px;overflow:auto;border-top:1px dashed #ddd;margin-top:4px;padding-top:4px"></div>
      <div style="display:flex;gap:4px;margin-top:4px">
        <input type="text" class="msgInput" style="flex:1">
        <input type="file" class="imgInput">
        <button class="btn sendBtn">Send</button>
        <button class="btn ghost cancelTicketBtn">Cancel Ticket</button>
        <button class="btn ghost markPaidBtn">Mark Paid</button>
        ${currentUserIsAdmin ? '<button class="btn ghost itemHiddenBtn">Item Hidden</button>' : ''}
        ${currentUserIsAdmin ? '<button class="btn completeOrderBtn" style="background:#ccc">Complete Order</button>' : ''}
      </div>
    `;
    area.appendChild(div);

    // Chat messages
    const chatEl = document.getElementById('chat-'+t.id);
    db.ref('messages/'+t.id).off();
    db.ref('messages/'+t.id).on('value', ms=>{
      const msgs = ms.val() || {};
      chatEl.innerHTML = Object.values(msgs).map(m=>{
        const displayName = (m.from === 'user-9e21mr' && currentUser !== 'user-9e21mr') ? 'admin' : m.from;
        return `<div><strong>${displayName}:</strong> ${m.text||''}${m.image?'<br><img src="'+m.image+'" style="max-width:100px">':''}</div>`;
      }).join('');
      chatEl.scrollTop = chatEl.scrollHeight;
    });

    // Send message
    div.querySelector('.sendBtn').onclick = ()=>{
      const inp = div.querySelector('.msgInput');
      const fileInp = div.querySelector('.imgInput');
      const txt = inp.value.trim();

      if(fileInp.files.length > 0){
        const file = fileInp.files[0];
        const reader = new FileReader();
        reader.onload = function(e){
          db.ref('messages/'+t.id).push({from:currentUser,image:e.target.result});
        };
        reader.readAsDataURL(file);
        fileInp.value='';
      }

      if(txt) db.ref('messages/'+t.id).push({from:currentUser,text:txt});
      inp.value='';
    };

    // Cancel Ticket
    div.querySelector('.cancelTicketBtn').onclick = ()=>{
      if(confirm('Are you sure you want to cancel this ticket?')){
        db.ref('tickets/'+t.id).remove();
        db.ref('messages/'+t.id).remove();
        div.remove();
      }
    };

    // Mark Paid
    div.querySelector('.markPaidBtn').onclick = ()=>{
      db.ref('messages/'+t.id).push({from:currentUser,text:'Payment hidden. Your product will be securely hidden and ready for pickup within 24 hours, please also provide photo of hidden payment and any location information.'});
    };

    // Admin: Item Hidden
    if(currentUserIsAdmin){
      div.querySelector('.itemHiddenBtn').onclick = ()=>{
        db.ref('messages/'+t.id).push({from:currentUser,text:'Item has been hidden. Refer to photos below for location of item. Have fun and practice safe usage.'});
        db.ref('tickets/'+t.id+'/status').set('complete');
        const completeBtn = div.querySelector('.completeOrderBtn');
        if(completeBtn){ completeBtn.style.background='green'; completeBtn.disabled=false; }
      };

      // Admin: Complete Order
      const compBtn = div.querySelector('.completeOrderBtn');
      if(compBtn){
        compBtn.disabled = true; // Start disabled until itemHiddenBtn clicked
        compBtn.onclick = ()=>{
          // Give user raffle ticket
          createRaffleTicket(t.user); // Assuming function from Part C
          db.ref('tickets/'+t.id+'/readyForReceived').set(true);
          alert('Order marked complete and raffle ticket issued to user.');
        };
      }
    }
  });
}
</script>
<script>
// ===== Admin Raffle Winner Button =====
function initAdminRaffleButton(){
  if(!currentUserIsAdmin) return;

  const raffleBtn = document.createElement('button');
  raffleBtn.className = 'btn';
  raffleBtn.innerText = 'Raffle Winner';
  const adminButtonsDiv = document.getElementById('refreshTickets').parentNode;
  adminButtonsDiv.appendChild(raffleBtn);

  raffleBtn.onclick = () => {
    // Create modal for entering user code
    const modalBack = document.createElement('div');
    modalBack.className = 'modal-back';
    modalBack.style.zIndex = 2000;
    modalBack.innerHTML = `
      <div class="modal">
        <h3>Raffle Winner</h3>
        <label>Enter user code: <input type="text" id="winnerCodeInput"></label>
        <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="submitWinnerBtn">Submit</button>
          <button class="btn ghost" id="closeWinnerModal">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(modalBack);

    // Close modal
    modalBack.querySelector('#closeWinnerModal').onclick = () => modalBack.remove();

    // Submit winner
    modalBack.querySelector('#submitWinnerBtn').onclick = () => {
      const winnerCode = modalBack.querySelector('#winnerCodeInput').value.trim();
      if(!winnerCode) return alert('Enter a user code');

      // Create raffle ticket for winner
      const ticketId = 'raffle-' + Date.now();
      const ticket = {
        id: ticketId,
        total: 0,
        location: 'RAFFLE',
        status: 'winner',
        items: [],
        user: winnerCode
      };
      db.ref('tickets/' + ticketId).set(ticket);
      db.ref('messages/' + ticketId).push({from: currentUser, text: 'RAFFLE WINNER! You have won the raffle.'});

      alert('Raffle winner ticket created for ' + winnerCode);
      modalBack.remove();
    };
  };
}

// Initialize raffle button after admin login
if(currentUserIsAdmin){
  initAdminRaffleButton();
}
</script>
</body>
</html>
